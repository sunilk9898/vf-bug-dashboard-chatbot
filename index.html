<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VF Bug Health - Dashboard & Chatbot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        .header {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            padding: 16px 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            flex-shrink: 0;
        }
        .header h1 { font-size: 22px; font-weight: 700; color: #f8fafc; }
        .header h1 span { color: #60a5fa; }
        .header-meta {
            display: flex; gap: 16px; align-items: center;
            font-size: 13px; color: #94a3b8;
        }
        .status-dot {
            width: 8px; height: 8px; background: #22c55e;
            border-radius: 50%; display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ========== NAV TABS ========== */
        .nav-tabs {
            display: flex;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 0 24px;
            flex-shrink: 0;
        }
        .nav-tab {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-tab:hover { color: #e2e8f0; }
        .nav-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .nav-tab .tab-icon { font-size: 16px; }

        /* ========== MAIN LAYOUT ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .tab-panel { display: none; flex: 1; overflow: auto; }
        .tab-panel.active { display: flex; flex-direction: column; }

        /* ========== DASHBOARD TAB ========== */
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 24px; width: 100%; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px; margin-bottom: 24px;
        }
        .card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 18px; text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .card .number { font-size: 32px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
        .card .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; }
        .card.total .number { color: #60a5fa; }
        .card.open .number { color: #f87171; }
        .card.progress .number { color: #fbbf24; }
        .card.review .number { color: #a78bfa; }
        .card.accepted .number { color: #34d399; }
        .card.parked .number { color: #94a3b8; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .chart-card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 20px;
        }
        .chart-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 14px; color: #f8fafc; }
        .bar-chart .bar-row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
        .bar-chart .bar-label { width: 110px; font-size: 12px; color: #cbd5e1; flex-shrink: 0; }
        .bar-chart .bar-track { flex: 1; height: 22px; background: #0f172a; border-radius: 6px; overflow: hidden; }
        .bar-chart .bar-fill {
            height: 100%; border-radius: 6px; transition: width 0.8s ease;
            display: flex; align-items: center; padding-left: 8px;
            font-size: 11px; font-weight: 600; color: #fff; min-width: fit-content;
        }
        .bar-chart .bar-value { width: 30px; text-align: right; font-size: 13px; font-weight: 700; color: #f8fafc; flex-shrink: 0; }
        .status-dist { display: flex; gap: 10px; flex-wrap: wrap; }
        .status-chip {
            display: flex; align-items: center; gap: 8px;
            background: #0f172a; padding: 10px 14px; border-radius: 10px;
            flex: 1; min-width: 120px;
        }
        .status-chip .dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .status-chip .info { display: flex; flex-direction: column; }
        .status-chip .info .val { font-size: 18px; font-weight: 700; }
        .status-chip .info .lbl { font-size: 10px; color: #94a3b8; text-transform: uppercase; }

        .table-section {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; overflow: hidden; margin-bottom: 24px;
        }
        .table-section h2 {
            padding: 14px 20px; font-size: 15px; font-weight: 600;
            border-bottom: 1px solid #334155; color: #f8fafc;
        }
        table { width: 100%; border-collapse: collapse; }
        thead th {
            background: #0f172a; padding: 10px 14px; text-align: center;
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
            color: #94a3b8; font-weight: 600;
        }
        thead th:first-child { text-align: left; padding-left: 20px; }
        tbody td { padding: 10px 14px; text-align: center; font-size: 13px; border-bottom: 1px solid #1e293b; }
        tbody td:first-child { text-align: left; padding-left: 20px; font-weight: 600; color: #f8fafc; }
        tbody tr { background: #1e293b; transition: background 0.15s; }
        tbody tr:nth-child(even) { background: #172033; }
        tbody tr:hover { background: #253449; }
        tbody tr.total-row { background: #0f172a; font-weight: 700; border-top: 2px solid #334155; }
        tbody tr.total-row td { color: #60a5fa; font-size: 14px; }
        .badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
        .badge-open { background: #7f1d1d; color: #fca5a5; }
        .badge-progress { background: #78350f; color: #fde68a; }
        .badge-reopened { background: #7c2d12; color: #fdba74; }
        .badge-review { background: #312e81; color: #c4b5fd; }
        .badge-accepted { background: #064e3b; color: #6ee7b7; }
        .badge-parked { background: #1e293b; color: #94a3b8; border: 1px solid #475569; }

        /* ========== CHATBOT TAB ========== */
        .chatbot-layout {
            flex: 1; display: flex; flex-direction: column;
            max-width: 900px; width: 100%; margin: 0 auto; padding: 0;
        }
        .chat-header-bar {
            background: #1e293b; border-bottom: 1px solid #334155;
            padding: 16px 24px;
            display: flex; align-items: center; gap: 12px;
        }
        .chat-header-bar .bot-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; flex-shrink: 0;
        }
        .chat-header-bar .bot-info h3 { font-size: 15px; font-weight: 600; color: #f8fafc; }
        .chat-header-bar .bot-info p { font-size: 12px; color: #94a3b8; }

        .chat-messages {
            flex: 1; overflow-y: auto; padding: 20px 24px;
            display: flex; flex-direction: column; gap: 16px;
        }
        .chat-msg { display: flex; gap: 10px; max-width: 85%; animation: fadeIn 0.3s ease; }
        .chat-msg.bot { align-self: flex-start; }
        .chat-msg.user { align-self: flex-end; flex-direction: row-reverse; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .chat-msg .avatar {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0;
        }
        .chat-msg.bot .avatar { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .chat-msg.user .avatar { background: #475569; }
        .chat-msg .bubble {
            padding: 12px 16px; border-radius: 16px;
            font-size: 14px; line-height: 1.5;
        }
        .chat-msg.bot .bubble { background: #1e293b; border: 1px solid #334155; border-top-left-radius: 4px; }
        .chat-msg.user .bubble { background: #1e40af; border-top-right-radius: 4px; }
        .chat-msg .bubble table { margin-top: 8px; font-size: 12px; }
        .chat-msg .bubble table th { padding: 4px 8px; background: #0f172a; color: #94a3b8; font-size: 10px; text-transform: uppercase; }
        .chat-msg .bubble table td { padding: 4px 8px; border-bottom: 1px solid #334155; }
        .chat-msg .bubble .inline-badge { display: inline-block; padding: 1px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; margin: 1px 2px; }

        .quick-actions {
            padding: 12px 24px; display: flex; gap: 8px; flex-wrap: wrap;
            border-top: 1px solid #1e293b;
        }
        .quick-btn {
            padding: 8px 14px; border-radius: 20px; font-size: 12px;
            background: #1e293b; border: 1px solid #334155; color: #94a3b8;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .quick-btn:hover { background: #253449; color: #e2e8f0; border-color: #60a5fa; }

        .chat-input-area {
            padding: 16px 24px; border-top: 1px solid #334155;
            background: #1e293b; display: flex; gap: 10px; align-items: center;
        }
        .chat-input {
            flex: 1; padding: 12px 16px; border-radius: 12px;
            border: 1px solid #334155; background: #0f172a; color: #e2e8f0;
            font-size: 14px; outline: none; font-family: inherit;
        }
        .chat-input:focus { border-color: #60a5fa; }
        .chat-input::placeholder { color: #475569; }
        .chat-send {
            width: 44px; height: 44px; border-radius: 12px;
            background: #2563eb; border: none; color: #fff;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-size: 18px; transition: background 0.2s;
            flex-shrink: 0;
        }
        .chat-send:hover { background: #3b82f6; }
        .chat-send:disabled { background: #334155; cursor: not-allowed; }

        .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
        .typing-indicator span {
            width: 8px; height: 8px; border-radius: 50%; background: #475569;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* ========== INSIGHTS TAB ========== */
        .insights-container { max-width: 1200px; margin: 0 auto; padding: 24px; width: 100%; }
        .insights-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .insight-card {
            background: #1e293b; border: 1px solid #334155; border-radius: 12px;
            padding: 20px;
        }
        .insight-card h3 { font-size: 14px; font-weight: 600; color: #f8fafc; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .insight-card .insight-icon { font-size: 18px; }
        .insight-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #0f172a;
            font-size: 13px;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-item .label { color: #cbd5e1; }
        .insight-item .value { font-weight: 700; }
        .insight-item .value.red { color: #f87171; }
        .insight-item .value.yellow { color: #fbbf24; }
        .insight-item .value.green { color: #34d399; }
        .insight-item .value.blue { color: #60a5fa; }
        .alert-banner {
            background: linear-gradient(135deg, #7f1d1d, #991b1b);
            border: 1px solid #dc2626; border-radius: 12px;
            padding: 16px 20px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 12px;
        }
        .alert-banner .alert-icon { font-size: 24px; }
        .alert-banner .alert-text h4 { font-size: 14px; font-weight: 600; color: #fca5a5; }
        .alert-banner .alert-text p { font-size: 12px; color: #fca5a5; opacity: 0.8; }

        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(15,23,42,0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; flex-direction: column; gap: 16px;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #334155;
            border-top-color: #60a5fa; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-banner {
            background: #7f1d1d; color: #fca5a5; padding: 14px 20px;
            border-radius: 8px; margin-bottom: 16px; display: none;
        }

        /* Footer */
        .footer { text-align: center; padding: 16px; color: #475569; font-size: 11px; flex-shrink: 0; }

        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid, .insights-grid { grid-template-columns: 1fr; }
            .header { padding: 12px 16px; }
            .header h1 { font-size: 16px; }
            .nav-tab { padding: 10px 14px; font-size: 13px; }
            .chat-msg { max-width: 95%; }
        }

        /* Btn refresh */
        .btn-refresh {
            background: #1e40af; color: #fff; border: none;
            padding: 6px 14px; border-radius: 8px; cursor: pointer;
            font-size: 12px; font-weight: 500; transition: background 0.2s;
        }
        .btn-refresh:hover { background: #2563eb; }
        .btn-refresh:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div style="color: #94a3b8; font-size: 14px;">Loading dashboard data...</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div>
            <h1>VF Bug Health <span>- Dashboard & Chatbot</span></h1>
        </div>
        <div class="header-meta">
            <span><span class="status-dot"></span> Live</span>
            <span id="lastUpdated">--</span>
            <button class="btn-refresh" id="refreshBtn" onclick="loadData()">Refresh</button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="dashboard">
            <span class="tab-icon">&#x1f4ca;</span> Dashboard
        </button>
        <button class="nav-tab" data-tab="chatbot">
            <span class="tab-icon">&#x1f4ac;</span> Chatbot
        </button>
        <button class="nav-tab" data-tab="insights">
            <span class="tab-icon">&#x1f4a1;</span> Insights
        </button>
    </div>

    <div class="main-content">
        <!-- ========== DASHBOARD TAB ========== -->
        <div class="tab-panel active" id="tab-dashboard">
            <div class="dashboard-container">
                <div class="error-banner" id="errorBanner"></div>
                <div class="summary-cards" id="summaryCards"></div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Status Distribution (All Platforms)</h3>
                        <div class="status-dist" id="statusDist"></div>
                    </div>
                    <div class="chart-card">
                        <h3>Platform Bug Count</h3>
                        <div class="bar-chart" id="platformChart"></div>
                    </div>
                </div>
                <div class="table-section">
                    <h2>Platform x Status Breakdown</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Platform</th>
                                <th>Open</th>
                                <th>In Progress</th>
                                <th>Reopened</th>
                                <th>In Review</th>
                                <th>Issue Accepted</th>
                                <th>Parked</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== CHATBOT TAB ========== -->
        <div class="tab-panel" id="tab-chatbot">
            <div class="chatbot-layout">
                <div class="chat-header-bar">
                    <div class="bot-avatar">&#x1f916;</div>
                    <div class="bot-info">
                        <h3>VZY Jira Assistant</h3>
                        <p>Ask me about bugs, tasks, sprint status & more</p>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="quick-actions" id="quickActions">
                    <button class="quick-btn" onclick="askBot('Show bug summary')">Bug Summary</button>
                    <button class="quick-btn" onclick="askBot('Show open bug tickets')">Open Tickets</button>
                    <button class="quick-btn" onclick="askBot('Show in progress bug tickets')">In Progress Tickets</button>
                    <button class="quick-btn" onclick="askBot('Show high priority bugs')">High Priority</button>
                    <button class="quick-btn" onclick="askBot('Show priority breakdown')">Priority Breakdown</button>
                    <button class="quick-btn" onclick="askBot('Show assignee workload')">Assignee Workload</button>
                    <button class="quick-btn" onclick="askBot('Sprint status')">Sprint Status</button>
                    <button class="quick-btn" onclick="askBot('Show all IOS tickets raised so far')">All IOS Tickets</button>
                    <button class="quick-btn" onclick="askBot('Show reopened bug tickets')">Reopened Tickets</button>
                    <button class="quick-btn" onclick="askBot('Compare platforms')">Compare Platforms</button>
                    <button class="quick-btn" onclick="askBot('Show tasks')">Tasks</button>
                    <button class="quick-btn" onclick="askBot('Critical platforms')">Critical Platforms</button>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput"
                           placeholder="Ask about bugs, tasks, sprint status..."
                           onkeydown="if(event.key==='Enter')sendMessage()">
                    <button class="chat-send" id="chatSendBtn" onclick="sendMessage()">&#x27A4;</button>
                </div>
            </div>
        </div>

        <!-- ========== INSIGHTS TAB ========== -->
        <div class="tab-panel" id="tab-insights">
            <div class="insights-container">
                <div id="alertArea"></div>
                <div class="insights-grid" id="insightsGrid"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        VF Bug Health Dashboard & Chatbot | Data sourced from Jira (VZY Project) | Auto-refreshes every 5 minutes
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            JIRA_DOMAIN: 'hbeindia.atlassian.net',
            JIRA_EMAIL: '',
            JIRA_API_TOKEN: '',
            PROJECT_KEY: 'VZY',
            USE_LIVE_API: false,
            AUTO_REFRESH_MS: 300000
        };

        const STATUSES = ['OPEN', 'IN PROGRESS', 'REOPENED', 'IN REVIEW', 'ISSUE ACCEPTED', 'PARKED'];
        const PLATFORMS = ['ANDROID', 'ATV', 'CMS Adaptor', 'CMS Dashboard', 'DishIT', 'IOS', 'LG_TV', 'SAM_TV', 'WEB'];

        const STATUS_COLORS = {
            'OPEN': '#ef4444', 'IN PROGRESS': '#f59e0b', 'REOPENED': '#f97316',
            'IN REVIEW': '#8b5cf6', 'ISSUE ACCEPTED': '#10b981', 'PARKED': '#64748b'
        };
        const STATUS_BADGE_CLASS = {
            'OPEN': 'badge-open', 'IN PROGRESS': 'badge-progress', 'REOPENED': 'badge-reopened',
            'IN REVIEW': 'badge-review', 'ISSUE ACCEPTED': 'badge-accepted', 'PARKED': 'badge-parked'
        };

        let dashboardData = null;
        let allIssues = null;

        // ============================================
        // STATIC FALLBACK DATA
        // ============================================
        function getStaticData() {
            return {
                'ANDROID':        { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 1, 'IN REVIEW': 1, 'ISSUE ACCEPTED': 1, 'PARKED': 1 },
                'ATV':            { 'OPEN': 0, 'IN PROGRESS': 1, 'REOPENED': 1, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 1, 'PARKED': 0 },
                'CMS Adaptor':    { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 1, 'PARKED': 0 },
                'CMS Dashboard':  { 'OPEN': 0, 'IN PROGRESS': 1, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 0, 'PARKED': 0 },
                'DishIT':         { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 0, 'PARKED': 1 },
                'IOS':            { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 0, 'IN REVIEW': 1, 'ISSUE ACCEPTED': 0, 'PARKED': 1 },
                'LG_TV':          { 'OPEN': 0, 'IN PROGRESS': 2, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 0, 'PARKED': 0 },
                'SAM_TV':         { 'OPEN': 0, 'IN PROGRESS': 1, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 1, 'PARKED': 0 },
                'WEB':            { 'OPEN': 2, 'IN PROGRESS': 0, 'REOPENED': 1, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 2, 'PARKED': 0 },
            };
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                if (tab.dataset.tab === 'chatbot' && document.getElementById('chatMessages').children.length === 0) {
                    initChatbot();
                }
                if (tab.dataset.tab === 'insights') {
                    renderInsights();
                }
            });
        });

        // ============================================
        // FETCH DATA
        // ============================================
        async function fetchDataJson() {
            const response = await fetch(`data.json?t=${Date.now()}`);
            if (!response.ok) throw new Error(`data.json not found (${response.status})`);
            return await response.json();
        }

        async function fetchDetailedData() {
            try {
                const response = await fetch(`detailed_data.json?t=${Date.now()}`);
                if (!response.ok) return null;
                return await response.json();
            } catch { return null; }
        }

        // ============================================
        // RENDER DASHBOARD
        // ============================================
        function renderDashboard(data) {
            dashboardData = data;
            const totals = {};
            STATUSES.forEach(s => totals[s] = 0);
            let grandTotal = 0;
            const platformTotals = {};

            PLATFORMS.forEach(p => {
                let pTotal = 0;
                STATUSES.forEach(s => {
                    const val = data[p]?.[s] || 0;
                    totals[s] += val;
                    pTotal += val;
                });
                platformTotals[p] = pTotal;
                grandTotal += pTotal;
            });

            // Summary cards
            const cardData = [
                { label: 'Total Issues', value: grandTotal, cls: 'total' },
                { label: 'Open', value: totals['OPEN'], cls: 'open' },
                { label: 'In Progress', value: totals['IN PROGRESS'], cls: 'progress' },
                { label: 'Reopened', value: totals['REOPENED'], cls: 'open' },
                { label: 'In Review', value: totals['IN REVIEW'], cls: 'review' },
                { label: 'Accepted', value: totals['ISSUE ACCEPTED'], cls: 'accepted' },
                { label: 'Parked', value: totals['PARKED'], cls: 'parked' }
            ];
            document.getElementById('summaryCards').innerHTML = cardData.map(c => `
                <div class="card ${c.cls}"><div class="number">${c.value}</div><div class="label">${c.label}</div></div>
            `).join('');

            // Status chips
            document.getElementById('statusDist').innerHTML = STATUSES.map(s => `
                <div class="status-chip">
                    <div class="dot" style="background: ${STATUS_COLORS[s]}"></div>
                    <div class="info"><span class="val">${totals[s]}</span><span class="lbl">${s}</span></div>
                </div>
            `).join('');

            // Bar chart
            const maxTotal = Math.max(...Object.values(platformTotals), 1);
            document.getElementById('platformChart').innerHTML = PLATFORMS
                .sort((a, b) => platformTotals[b] - platformTotals[a])
                .map(p => {
                    const pct = (platformTotals[p] / maxTotal * 100).toFixed(0);
                    const color = platformTotals[p] >= 4 ? '#ef4444' : platformTotals[p] >= 2 ? '#f59e0b' : '#10b981';
                    return `<div class="bar-row">
                        <div class="bar-label">${p}</div>
                        <div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,5)}%;background:${color}">${platformTotals[p]}</div></div>
                        <div class="bar-value">${platformTotals[p]}</div>
                    </div>`;
                }).join('');

            // Table
            let tableHTML = '';
            PLATFORMS.forEach(p => {
                let rowTotal = platformTotals[p];
                tableHTML += `<tr><td>${p}</td>
                    ${STATUSES.map(s => {
                        const val = data[p]?.[s] || 0;
                        return `<td>${val > 0 ? `<span class="badge ${STATUS_BADGE_CLASS[s]}">${val}</span>` : '<span style="color:#475569">0</span>'}</td>`;
                    }).join('')}
                    <td><strong style="color:${rowTotal >= 4 ? '#f87171' : rowTotal >= 2 ? '#fbbf24' : '#34d399'}">${rowTotal}</strong></td>
                </tr>`;
            });
            tableHTML += `<tr class="total-row"><td>Total Unique Issues:</td>
                ${STATUSES.map(s => `<td>${totals[s]}</td>`).join('')}
                <td>${grandTotal}</td></tr>`;
            document.getElementById('tableBody').innerHTML = tableHTML;
            document.getElementById('lastUpdated').textContent = `Updated: ${new Date().toLocaleString()}`;
        }

        // ============================================
        // INSIGHTS TAB
        // ============================================
        function renderInsights() {
            if (!dashboardData) return;
            const data = dashboardData;
            const platformTotals = {};
            const totals = {};
            STATUSES.forEach(s => totals[s] = 0);
            let grandTotal = 0;

            PLATFORMS.forEach(p => {
                let pTotal = 0;
                STATUSES.forEach(s => {
                    const val = data[p]?.[s] || 0;
                    totals[s] += val;
                    pTotal += val;
                });
                platformTotals[p] = pTotal;
                grandTotal += pTotal;
            });

            // Alerts
            const criticalPlatforms = PLATFORMS.filter(p => platformTotals[p] >= 4);
            const reopenedTotal = totals['REOPENED'] || 0;
            let alertHTML = '';
            if (criticalPlatforms.length > 0) {
                alertHTML += `<div class="alert-banner">
                    <div class="alert-icon">&#x26A0;</div>
                    <div class="alert-text">
                        <h4>Critical Platforms</h4>
                        <p>${criticalPlatforms.join(', ')} have 4+ active bugs requiring attention</p>
                    </div>
                </div>`;
            }
            if (reopenedTotal >= 3) {
                alertHTML += `<div class="alert-banner" style="background:linear-gradient(135deg,#78350f,#92400e);border-color:#f59e0b;">
                    <div class="alert-icon">&#x1f504;</div>
                    <div class="alert-text">
                        <h4>High Reopen Rate</h4>
                        <p>${reopenedTotal} bugs have been reopened - review fix quality</p>
                    </div>
                </div>`;
            }
            document.getElementById('alertArea').innerHTML = alertHTML;

            // Insight cards
            const sortedPlatforms = [...PLATFORMS].sort((a, b) => platformTotals[b] - platformTotals[a]);
            const activeStatuses = ['OPEN', 'IN PROGRESS', 'REOPENED'];
            const activeCount = activeStatuses.reduce((sum, s) => sum + (totals[s] || 0), 0);
            const reviewCount = (totals['IN REVIEW'] || 0) + (totals['ISSUE ACCEPTED'] || 0);

            let insightsHTML = `
            <div class="insight-card">
                <h3><span class="insight-icon">&#x1f4cb;</span> Bug Overview</h3>
                <div class="insight-item"><span class="label">Total Active Bugs</span><span class="value blue">${grandTotal}</span></div>
                <div class="insight-item"><span class="label">Needs Action (Open/InProgress/Reopened)</span><span class="value red">${activeCount}</span></div>
                <div class="insight-item"><span class="label">In Review / Accepted</span><span class="value green">${reviewCount}</span></div>
                <div class="insight-item"><span class="label">Parked</span><span class="value yellow">${totals['PARKED'] || 0}</span></div>
            </div>
            <div class="insight-card">
                <h3><span class="insight-icon">&#x1f3af;</span> Platform Ranking (by bug count)</h3>
                ${sortedPlatforms.map((p, i) => {
                    const clr = platformTotals[p] >= 4 ? 'red' : platformTotals[p] >= 2 ? 'yellow' : 'green';
                    return `<div class="insight-item"><span class="label">${i + 1}. ${p}</span><span class="value ${clr}">${platformTotals[p]}</span></div>`;
                }).join('')}
            </div>
            <div class="insight-card">
                <h3><span class="insight-icon">&#x1f6a8;</span> Status Hotspots</h3>
                ${STATUSES.map(s => {
                    const platforms = PLATFORMS.filter(p => (data[p]?.[s] || 0) > 0);
                    if (platforms.length === 0) return '';
                    return `<div class="insight-item"><span class="label">${s}</span><span class="value">${platforms.join(', ')}</span></div>`;
                }).join('')}
            </div>
            <div class="insight-card">
                <h3><span class="insight-icon">&#x2705;</span> Healthy Platforms</h3>
                ${PLATFORMS.filter(p => platformTotals[p] <= 1).map(p =>
                    `<div class="insight-item"><span class="label">${p}</span><span class="value green">${platformTotals[p]} bug${platformTotals[p] !== 1 ? 's' : ''}</span></div>`
                ).join('') || '<div class="insight-item"><span class="label">No platform has 0-1 bugs</span><span class="value yellow">--</span></div>'}
            </div>`;

            document.getElementById('insightsGrid').innerHTML = insightsHTML;
        }

        // ============================================
        // CHATBOT
        // ============================================
        function initChatbot() {
            addBotMessage(`Hello! I'm the <b>VZY Jira Assistant</b>. I can help you with detailed bug, task, and project information.<br><br>
                <b>What I can do:</b><br>
                &#x2022; <b>Show tickets</b> - "show open bug tickets", "list in progress tickets"<br>
                &#x2022; <b>Platform bugs</b> - "Android bugs", "all IOS tickets raised so far"<br>
                &#x2022; <b>Assignee info</b> - "assigned to [name]", "assignee workload"<br>
                &#x2022; <b>Priority</b> - "high priority bugs", "priority breakdown"<br>
                &#x2022; <b>Sprint</b> - "sprint status"<br>
                &#x2022; <b>Search</b> - "search video playback"<br>
                &#x2022; <b>Tasks/Stories</b> - "show tasks", "show stories"<br>
                &#x2022; <b>Dashboard</b> - bug summary, compare platforms, critical platforms<br><br>
                Try the quick action buttons below or type your question!`);
        }

        function addBotMessage(html) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg bot';
            msg.innerHTML = `<div class="avatar">&#x1f916;</div><div class="bubble">${html}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function addUserMessage(text) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg user';
            msg.innerHTML = `<div class="avatar">&#x1f464;</div><div class="bubble">${escapeHtml(text)}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping() {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg bot';
            msg.id = 'typingMsg';
            msg.innerHTML = `<div class="avatar">&#x1f916;</div><div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const el = document.getElementById('typingMsg');
            if (el) el.remove();
        }

        function escapeHtml(str) {
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function askBot(query) {
            document.getElementById('chatInput').value = query;
            sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            addUserMessage(text);
            showTyping();
            setTimeout(() => {
                hideTyping();
                const response = processQuery(text);
                addBotMessage(response);
            }, 500 + Math.random() * 500);
        }

        // ============================================
        // CHATBOT HELPER FUNCTIONS
        // ============================================
        const STATUS_NAME_MAP = {
            'OPEN': 'Open', 'IN PROGRESS': 'In Progress', 'REOPENED': 'Reopened',
            'IN REVIEW': 'In Review', 'ISSUE ACCEPTED': 'Issue Accepted', 'PARKED': 'Parked'
        };

        function buildTicketTable(items, maxRows = 20) {
            if (!items || items.length === 0) return '<br>No tickets found.';
            const display = items.slice(0, maxRows);
            let html = `<table style="width:100%;margin-top:8px"><thead><tr>
                <th style="text-align:left">Key</th><th style="text-align:left">Summary</th><th>Platform</th><th>Assignee</th><th>Priority</th><th>Status</th>
            </tr></thead><tbody>`;
            display.forEach(item => {
                const pColor = item.priority === 'Highest' ? '#ef4444' : item.priority === 'High' ? '#f97316' : item.priority === 'Medium' ? '#fbbf24' : '#94a3b8';
                html += `<tr>
                    <td style="white-space:nowrap;font-size:11px"><b>${escapeHtml(item.key)}</b></td>
                    <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml((item.summary || '').substring(0, 60))}</td>
                    <td style="font-size:11px;text-align:center">${item.platform || 'N/A'}</td>
                    <td style="font-size:11px;text-align:center">${(item.assignee || 'Unassigned').split(' ')[0]}</td>
                    <td style="font-size:11px;text-align:center;color:${pColor}">${item.priority || 'N/A'}</td>
                    <td style="font-size:10px;text-align:center"><span class="inline-badge">${item.status}</span></td>
                </tr>`;
            });
            html += `</tbody></table>`;
            if (items.length > maxRows) {
                html += `<br><small style="color:#94a3b8">Showing ${maxRows} of ${items.length} tickets. Narrow down by platform, assignee, or priority.</small>`;
            }
            return html;
        }

        function filterBugs(opts = {}) {
            if (!allIssues || !allIssues.bugs) return [];
            let results = allIssues.bugs;
            if (opts.status) results = results.filter(b => b.status && b.status.toUpperCase() === opts.status.toUpperCase());
            if (opts.statusList) results = results.filter(b => b.status && opts.statusList.some(s => b.status.toUpperCase() === s.toUpperCase()));
            if (opts.platform) results = results.filter(b => b.platform && b.platform.toUpperCase() === opts.platform.toUpperCase());
            if (opts.assignee) results = results.filter(b => b.assignee && b.assignee.toLowerCase().includes(opts.assignee.toLowerCase()));
            if (opts.priority) results = results.filter(b => b.priority && b.priority.toUpperCase() === opts.priority.toUpperCase());
            if (opts.keyword) results = results.filter(b => b.summary && b.summary.toLowerCase().includes(opts.keyword.toLowerCase()));
            return results;
        }

        function filterItems(type, opts = {}) {
            if (!allIssues) return [];
            let items = allIssues[type] || [];
            if (opts.platform) items = items.filter(i => i.platform && i.platform.toUpperCase() === opts.platform.toUpperCase());
            if (opts.status) items = items.filter(i => i.status && i.status.toUpperCase() === opts.status.toUpperCase());
            if (opts.keyword) items = items.filter(i => i.summary && i.summary.toLowerCase().includes(opts.keyword.toLowerCase()));
            return items;
        }

        // ============================================
        // CHATBOT QUERY PROCESSOR
        // ============================================
        function processQuery(query) {
            if (!dashboardData) return 'Dashboard data is not loaded yet. Please refresh and try again.';
            const q = query.toLowerCase().trim();
            const data = dashboardData;

            // Compute dashboard helper data
            const platformTotals = {};
            const totals = {};
            STATUSES.forEach(s => totals[s] = 0);
            let grandTotal = 0;
            PLATFORMS.forEach(p => {
                let pTotal = 0;
                STATUSES.forEach(s => {
                    const val = data[p]?.[s] || 0;
                    totals[s] += val;
                    pTotal += val;
                });
                platformTotals[p] = pTotal;
                grandTotal += pTotal;
            });

            const matchedPlatform = PLATFORMS.find(p => q.includes(p.toLowerCase()));

            // ==============================================
            // DETAILED DATA QUERIES (uses allIssues)
            // ==============================================

            // --- SEARCH: "search [keyword]" or "find [keyword]" ---
            if (allIssues && (q.startsWith('search ') || q.startsWith('find '))) {
                const keyword = q.replace(/^(search|find)\s+/, '').trim();
                if (keyword.length < 2) return 'Please provide a search term (at least 2 characters).';
                const results = filterBugs({ keyword });
                let html = `<b>Search Results for "${escapeHtml(keyword)}"</b><br>Found: <b style="color:#60a5fa">${results.length}</b> bugs<br>`;
                html += buildTicketTable(results);
                return html;
            }

            // --- SPRINT STATUS ---
            if (allIssues && q.includes('sprint')) {
                const sprints = allIssues.sprints;
                if (!sprints || Object.keys(sprints).length === 0) return 'No sprint data available in the project.';
                let html = `<b>Sprint Status</b><br><br>`;
                Object.entries(sprints).forEach(([name, sprintData]) => {
                    html += `&#x1f3c3; <b>${escapeHtml(name)}</b><br>`;
                    html += `Total: <b>${sprintData.total}</b> (Bugs: ${sprintData.bugs}, Tasks: ${sprintData.tasks}, Stories: ${sprintData.stories})<br>`;
                    html += `<table style="width:100%;margin:4px 0 12px"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                    Object.entries(sprintData.statuses).sort((a,b) => b[1] - a[1]).forEach(([status, count]) => {
                        html += `<tr><td>${status}</td><td style="text-align:center"><b>${count}</b></td></tr>`;
                    });
                    html += `</tbody></table>`;
                });
                return html;
            }

            // --- ASSIGNEE QUERIES ---
            if (allIssues && (q.includes('assigned to') || q.includes('bugs of'))) {
                const nameMatch = q.match(/(?:assigned to|bugs of)\s+(.+)/);
                if (nameMatch) {
                    const name = nameMatch[1].trim();
                    const bugs = filterBugs({ assignee: name });
                    let html = `<b>Bugs Assigned to "${escapeHtml(name)}"</b><br>Found: <b style="color:#60a5fa">${bugs.length}</b><br>`;
                    html += buildTicketTable(bugs);
                    return html;
                }
            }
            if (allIssues && (q.includes('assignee') || q.includes('workload') || q.includes('who has most'))) {
                const workload = allIssues.assignee_workload || {};
                const sorted = Object.entries(workload).sort((a,b) => b[1].total - a[1].total).slice(0, 20);
                let html = `<b>Assignee Workload (Top 20)</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th style="text-align:left">Assignee</th><th>Bugs</th><th>Tasks</th><th>Total</th></tr></thead><tbody>`;
                sorted.forEach(([name, d]) => {
                    html += `<tr><td style="font-size:12px">${escapeHtml(name)}</td><td style="text-align:center">${d.bugs}</td><td style="text-align:center">${d.tasks}</td><td style="text-align:center"><b>${d.total}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                return html;
            }

            // --- PRIORITY QUERIES ---
            if (allIssues && q.includes('priority')) {
                const priorities = ['Highest', 'High', 'Medium', 'Low', 'Lowest'];
                const matchedPriority = priorities.find(p => q.includes(p.toLowerCase()));
                if (matchedPriority) {
                    const bugs = filterBugs({ priority: matchedPriority });
                    let html = `<b>${matchedPriority} Priority Bugs</b><br>Found: <b style="color:#60a5fa">${bugs.length}</b><br>`;
                    html += buildTicketTable(bugs);
                    return html;
                }
                // Show breakdown
                const pb = allIssues.priority_breakdown || {};
                let html = `<b>Bug Priority Breakdown</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Priority</th><th>Count</th></tr></thead><tbody>`;
                const pColors = {'Highest':'#ef4444','High':'#f97316','Medium':'#fbbf24','Low':'#34d399','Lowest':'#94a3b8'};
                priorities.forEach(p => {
                    if (pb[p]) html += `<tr><td><b style="color:${pColors[p]||'#e2e8f0'}">${p}</b></td><td style="text-align:center"><b>${pb[p]}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                return html;
            }

            // --- TASK QUERIES ---
            if (allIssues && q.includes('task')) {
                const tasks = filterItems('tasks', { platform: matchedPlatform || undefined });
                let html = `<b>Tasks${matchedPlatform ? ' - ' + matchedPlatform : ''}</b><br>Total: <b style="color:#60a5fa">${tasks.length}</b><br>`;
                html += buildTicketTable(tasks);
                return html;
            }

            // --- STORY QUERIES ---
            if (allIssues && q.includes('stor')) {
                const stories = filterItems('stories');
                let html = `<b>Stories</b><br>Total: <b style="color:#60a5fa">${stories.length}</b><br>`;
                html += buildTicketTable(stories);
                return html;
            }

            // --- ALL TICKETS / HISTORICAL / TOTAL RAISED ---
            if (allIssues && (q.includes('raised') || q.includes('so far') || q.includes('historical') || q.includes('ever') ||
                (q.includes('all') && q.includes('ticket')) || (q.includes('total') && matchedPlatform && !q.includes('summary')))) {
                let bugs = allIssues.bugs || [];
                if (matchedPlatform) bugs = bugs.filter(b => b.platform && b.platform.toUpperCase() === matchedPlatform.toUpperCase());
                const statusCounts = {};
                bugs.forEach(b => { statusCounts[b.status] = (statusCounts[b.status] || 0) + 1; });
                let html = `<b>All ${matchedPlatform || ''} Bugs Raised (Historical)</b><br><br>`;
                html += `Total: <b style="color:#60a5fa">${bugs.length}</b> bugs across all statuses<br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                Object.entries(statusCounts).sort((a,b) => b[1] - a[1]).forEach(([status, count]) => {
                    html += `<tr><td>${status}</td><td style="text-align:center"><b>${count}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                html += `<br><b>Recent Tickets:</b>`;
                html += buildTicketTable(bugs.slice(0, 15), 15);
                return html;
            }

            // --- TICKET / JIRA ID QUERIES (with status/platform filters) ---
            if (allIssues && (q.includes('ticket') || q.includes('jira') || q.match(/vf-\d/))) {
                // Detect status filter from query
                let statusFilter = null;
                for (const [dashName, detailName] of Object.entries(STATUS_NAME_MAP)) {
                    if (q.includes(dashName.toLowerCase())) { statusFilter = detailName; break; }
                }
                // Also check direct status names
                if (!statusFilter) {
                    const allStatuses = [...new Set((allIssues.bugs || []).map(b => b.status))];
                    statusFilter = allStatuses.find(s => q.includes(s.toLowerCase())) || null;
                }
                // Check specific ticket ID
                const ticketMatch = q.match(/vf-(\d+)/i);
                if (ticketMatch) {
                    const ticketKey = 'VF-' + ticketMatch[1];
                    const allItems = [...(allIssues.bugs || []), ...(allIssues.tasks || []), ...(allIssues.stories || [])];
                    const found = allItems.find(i => i.key.toUpperCase() === ticketKey.toUpperCase());
                    if (found) {
                        let html = `<b>Ticket: ${found.key}</b><br><br>`;
                        html += `<b>Summary:</b> ${escapeHtml(found.summary)}<br>`;
                        html += `<b>Type:</b> ${found.type}<br>`;
                        html += `<b>Status:</b> ${found.status}<br>`;
                        html += `<b>Priority:</b> ${found.priority}<br>`;
                        html += `<b>Platform:</b> ${found.platform}<br>`;
                        html += `<b>Assignee:</b> ${found.assignee}<br>`;
                        html += `<b>Created:</b> ${found.created}<br>`;
                        html += `<b>Updated:</b> ${found.updated}<br>`;
                        html += `<b>Sprint:</b> ${found.sprint}<br>`;
                        html += `<br><a href="https://hbeindia.atlassian.net/browse/${found.key}" target="_blank" style="color:#60a5fa">Open in Jira &#x2197;</a>`;
                        return html;
                    } else {
                        return `Ticket <b>${ticketKey}</b> not found in the data.`;
                    }
                }

                const filtered = filterBugs({
                    status: statusFilter || undefined,
                    platform: matchedPlatform || undefined
                });
                let title = 'Jira Bug Tickets';
                if (statusFilter) title += ` - ${statusFilter}`;
                if (matchedPlatform) title += ` (${matchedPlatform})`;
                let html = `<b>${title}</b><br>Found: <b style="color:#60a5fa">${filtered.length}</b> tickets<br>`;
                html += buildTicketTable(filtered);
                return html;
            }

            // ==============================================
            // DASHBOARD AGGREGATE QUERIES (uses dashboardData)
            // ==============================================

            // Bug Summary
            if (q.includes('summary') || q.includes('overview') || q === 'bugs' || q === 'bug summary') {
                let html = `<b>Bug Summary (VZY Project)</b><br><br>`;
                html += `Total Active Bugs: <b style="color:#60a5fa">${grandTotal}</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                STATUSES.forEach(s => {
                    html += `<tr><td><span class="inline-badge" style="background:${STATUS_COLORS[s]}33;color:${STATUS_COLORS[s]}">${s}</span></td><td style="text-align:center"><b>${totals[s]}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                if (allIssues) {
                    const totalAll = (allIssues.bugs || []).length;
                    html += `<br><small style="color:#94a3b8">Total bugs raised (all statuses): <b>${totalAll}</b> | Tasks: <b>${(allIssues.tasks || []).length}</b> | Stories: <b>${(allIssues.stories || []).length}</b></small>`;
                }
                return html;
            }

            // Specific platform query
            if (matchedPlatform) {
                const pData = data[matchedPlatform] || {};
                const pTotal = platformTotals[matchedPlatform];
                let html = `<b>${matchedPlatform} Bugs (Active)</b><br><br>`;
                html += `Active: <b style="color:${pTotal >= 4 ? '#f87171' : pTotal >= 2 ? '#fbbf24' : '#34d399'}">${pTotal}</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                STATUSES.forEach(s => {
                    const val = pData[s] || 0;
                    if (val > 0) {
                        html += `<tr><td><span class="inline-badge" style="background:${STATUS_COLORS[s]}33;color:${STATUS_COLORS[s]}">${s}</span></td><td style="text-align:center"><b>${val}</b></td></tr>`;
                    }
                });
                html += `</tbody></table>`;
                // Append ticket details
                if (allIssues) {
                    const activeStatuses = Object.values(STATUS_NAME_MAP);
                    const tickets = filterBugs({ platform: matchedPlatform, statusList: activeStatuses });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                    const allPlatformBugs = filterBugs({ platform: matchedPlatform });
                    html += `<br><small style="color:#94a3b8">Total ${matchedPlatform} bugs raised (all statuses): <b>${allPlatformBugs.length}</b></small>`;
                }
                if (pTotal === 0 && !allIssues) html += `<br>No active bugs on this platform.`;
                return html;
            }

            // Status-based queries
            for (const status of STATUSES) {
                if (q.includes(status.toLowerCase())) {
                    const platforms = PLATFORMS.filter(p => (data[p]?.[status] || 0) > 0);
                    let html = `<b>${status} Bugs</b><br><br>`;
                    html += `Total: <b style="color:${STATUS_COLORS[status]}">${totals[status]}</b><br><br>`;
                    if (platforms.length === 0) {
                        html += `No bugs currently in ${status} status.`;
                    } else {
                        html += `<table style="width:100%"><thead><tr><th>Platform</th><th>Count</th></tr></thead><tbody>`;
                        platforms.forEach(p => {
                            html += `<tr><td>${p}</td><td style="text-align:center"><b>${data[p][status]}</b></td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                    // Append ticket details
                    if (allIssues) {
                        const detailedStatus = STATUS_NAME_MAP[status];
                        if (detailedStatus) {
                            const tickets = filterBugs({ status: detailedStatus });
                            if (tickets.length > 0) {
                                html += `<br><b>Ticket Details:</b>`;
                                html += buildTicketTable(tickets);
                            }
                        }
                    }
                    return html;
                }
            }

            // Open bugs
            if (q.includes('open')) {
                const platforms = PLATFORMS.filter(p => (data[p]?.['OPEN'] || 0) > 0);
                let html = `<b>Open Bugs</b><br><br>Total: <b style="color:#ef4444">${totals['OPEN']}</b><br><br>`;
                if (platforms.length === 0) html += 'No open bugs currently!';
                else {
                    html += `<table style="width:100%"><thead><tr><th>Platform</th><th>Count</th></tr></thead><tbody>`;
                    platforms.forEach(p => html += `<tr><td>${p}</td><td style="text-align:center"><b>${data[p]['OPEN']}</b></td></tr>`);
                    html += `</tbody></table>`;
                }
                if (allIssues) {
                    const tickets = filterBugs({ status: 'Open' });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                }
                return html;
            }

            // Top / most / highest platform
            if (q.includes('most') || q.includes('top') || q.includes('highest') || q.includes('worst')) {
                const sorted = [...PLATFORMS].sort((a, b) => platformTotals[b] - platformTotals[a]);
                const top = sorted[0];
                let html = `<b>Platform with Most Bugs</b><br><br>`;
                html += `<b style="color:#f87171">${top}</b> has the most bugs with <b>${platformTotals[top]}</b> total.<br><br>`;
                html += `<b>Full Ranking:</b><br>`;
                sorted.forEach((p, i) => {
                    const clr = platformTotals[p] >= 4 ? '#f87171' : platformTotals[p] >= 2 ? '#fbbf24' : '#34d399';
                    html += `${i + 1}. ${p}: <b style="color:${clr}">${platformTotals[p]}</b><br>`;
                });
                return html;
            }

            // Compare platforms
            if (q.includes('compare') || q.includes('comparison') || q.includes('breakdown') || q.includes('platform-wise') || q.includes('all platform')) {
                let html = `<b>Platform Comparison</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Platform</th>`;
                STATUSES.forEach(s => html += `<th style="font-size:9px">${s.split(' ').map(w=>w[0]).join('')}</th>`);
                html += `<th>Total</th></tr></thead><tbody>`;
                [...PLATFORMS].sort((a, b) => platformTotals[b] - platformTotals[a]).forEach(p => {
                    html += `<tr><td style="font-size:12px">${p}</td>`;
                    STATUSES.forEach(s => {
                        const val = data[p]?.[s] || 0;
                        html += `<td style="text-align:center">${val > 0 ? `<b>${val}</b>` : '<span style="color:#475569">0</span>'}</td>`;
                    });
                    html += `<td style="text-align:center"><b>${platformTotals[p]}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                html += `<br><small>Columns: O=Open, IP=InProgress, R=Reopened, IR=InReview, IA=Accepted, P=Parked</small>`;
                return html;
            }

            // Critical platforms
            if (q.includes('critical') || q.includes('attention') || q.includes('alert') || q.includes('warning')) {
                const critical = PLATFORMS.filter(p => platformTotals[p] >= 4);
                const warning = PLATFORMS.filter(p => platformTotals[p] >= 2 && platformTotals[p] < 4);
                let html = `<b>Platform Health Status</b><br><br>`;
                if (critical.length > 0) {
                    html += `<span style="color:#f87171">&#x1f534; Critical (4+ bugs):</span><br>`;
                    critical.forEach(p => html += `&nbsp;&nbsp;&#x2022; ${p}: <b>${platformTotals[p]}</b> bugs<br>`);
                } else {
                    html += `<span style="color:#34d399">No critical platforms (4+ bugs)</span><br>`;
                }
                html += `<br>`;
                if (warning.length > 0) {
                    html += `<span style="color:#fbbf24">&#x1f7e1; Warning (2-3 bugs):</span><br>`;
                    warning.forEach(p => html += `&nbsp;&nbsp;&#x2022; ${p}: <b>${platformTotals[p]}</b> bugs<br>`);
                }
                return html;
            }

            // Healthy platforms
            if (q.includes('health') || q.includes('good') || q.includes('clean')) {
                const healthy = PLATFORMS.filter(p => platformTotals[p] <= 1);
                let html = `<b>Healthy Platforms (0-1 bugs)</b><br><br>`;
                if (healthy.length > 0) {
                    healthy.forEach(p => html += `<span style="color:#34d399">&#x2705;</span> ${p}: <b>${platformTotals[p]}</b> bug${platformTotals[p] !== 1 ? 's' : ''}<br>`);
                } else {
                    html += `No platform currently has 0-1 bugs.`;
                }
                return html;
            }

            // Reopened
            if (q.includes('reopen')) {
                const platforms = PLATFORMS.filter(p => (data[p]?.['REOPENED'] || 0) > 0);
                let html = `<b>Reopened Bugs</b><br><br>Total: <b style="color:#f97316">${totals['REOPENED']}</b><br><br>`;
                if (platforms.length > 0) {
                    platforms.forEach(p => html += `&#x2022; ${p}: <b>${data[p]['REOPENED']}</b><br>`);
                } else {
                    html += 'No reopened bugs currently!';
                }
                if (allIssues) {
                    const tickets = filterBugs({ status: 'Reopened' });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                }
                return html;
            }

            // Parked
            if (q.includes('park')) {
                const platforms = PLATFORMS.filter(p => (data[p]?.['PARKED'] || 0) > 0);
                let html = `<b>Parked Bugs</b><br><br>Total: <b style="color:#64748b">${totals['PARKED']}</b><br><br>`;
                if (platforms.length > 0) {
                    platforms.forEach(p => html += `&#x2022; ${p}: <b>${data[p]['PARKED']}</b><br>`);
                } else {
                    html += 'No parked bugs currently.';
                }
                if (allIssues) {
                    const tickets = filterBugs({ status: 'Parked' });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                }
                return html;
            }

            // Help
            if (q.includes('help') || q.includes('what can')) {
                return `<b>What I can do:</b><br><br>
                    <b>Ticket Details:</b><br>
                    &#x2022; "show open bug tickets" - List tickets by status<br>
                    &#x2022; "VF-1234" - Look up a specific ticket<br>
                    &#x2022; "search video playback" - Search by keyword<br><br>
                    <b>Historical Data:</b><br>
                    &#x2022; "all IOS tickets raised so far" - Full history by platform<br>
                    &#x2022; "total android bugs" - All-time counts<br><br>
                    <b>People & Priority:</b><br>
                    &#x2022; "assigned to [name]" - Bugs by assignee<br>
                    &#x2022; "assignee workload" - Who has the most work<br>
                    &#x2022; "high priority bugs" - Filter by priority<br>
                    &#x2022; "priority breakdown" - Priority distribution<br><br>
                    <b>Sprint & Tasks:</b><br>
                    &#x2022; "sprint status" - Sprint progress<br>
                    &#x2022; "show tasks" - List all tasks<br>
                    &#x2022; "show stories" - List all stories<br><br>
                    <b>Dashboard:</b><br>
                    &#x2022; "bug summary" - Overview counts<br>
                    &#x2022; "Android bugs" - Platform details<br>
                    &#x2022; "compare platforms" - Side-by-side<br>
                    &#x2022; "critical platforms" - Platforms needing attention`;
            }

            // Fallback
            return `I'm not sure how to answer that. Try:<br><br>
                &#x2022; "show open bug tickets" - Tickets with Jira IDs<br>
                &#x2022; "all IOS tickets raised so far" - Full history<br>
                &#x2022; "assigned to [name]" - Bugs by person<br>
                &#x2022; "high priority bugs" - By priority<br>
                &#x2022; "search [keyword]" - Search bugs<br>
                &#x2022; "sprint status" - Sprint info<br>
                &#x2022; "bug summary" - Overview<br><br>
                Type <b>"help"</b> for the full list.`;
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadData() {
            const btn = document.getElementById('refreshBtn');
            const loading = document.getElementById('loading');
            const errorBanner = document.getElementById('errorBanner');

            btn.disabled = true;
            btn.textContent = 'Loading...';
            errorBanner.style.display = 'none';

            try {
                const json = await fetchDataJson();
                renderDashboard(json.data);
                document.getElementById('lastUpdated').textContent =
                    `Updated: ${new Date(json.updated_at).toLocaleString()} (auto-synced from Jira)`;
                loading.style.display = 'none';

                // Also try to load detailed data for chatbot
                const detailed = await fetchDetailedData();
                if (detailed) allIssues = detailed;
            } catch (err) {
                console.warn('data.json not available, using static fallback:', err.message);
                try {
                    renderDashboard(getStaticData());
                    document.getElementById('lastUpdated').textContent =
                        `Updated: ${new Date().toLocaleString()} (static fallback)`;
                } catch (e) {}
                loading.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh';
            }
        }

        // Initial load
        loadData();
        setInterval(loadData, CONFIG.AUTO_REFRESH_MS);
    </script>
</body>
</html>
