<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VF Bug Health - Dashboard & Chatbot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        .header {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            padding: 16px 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            flex-shrink: 0;
        }
        .header h1 { font-size: 22px; font-weight: 700; color: #f8fafc; }
        .header h1 span { color: #60a5fa; }
        .header-meta {
            display: flex; gap: 16px; align-items: center;
            font-size: 13px; color: #94a3b8;
        }
        .status-dot {
            width: 8px; height: 8px; background: #22c55e;
            border-radius: 50%; display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ========== NAV TABS ========== */
        .nav-tabs {
            display: flex;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 0 24px;
            flex-shrink: 0;
        }
        .nav-tab {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-tab:hover { color: #e2e8f0; }
        .nav-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .nav-tab .tab-icon { font-size: 16px; }

        /* ========== MAIN LAYOUT ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .tab-panel { display: none; flex: 1; overflow: auto; }
        .tab-panel.active { display: flex; flex-direction: column; }

        /* ========== DASHBOARD TAB ========== */
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 24px; width: 100%; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px; margin-bottom: 24px;
        }
        .card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 18px; text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .card .number { font-size: 32px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
        .card .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; }
        .card.total .number { color: #60a5fa; }
        .card.open .number { color: #f87171; }
        .card.progress .number { color: #fbbf24; }
        .card.review .number { color: #a78bfa; }
        .card.accepted .number { color: #34d399; }
        .card.parked .number { color: #94a3b8; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .chart-card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 20px;
        }
        .chart-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 14px; color: #f8fafc; }
        .bar-chart .bar-row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
        .bar-chart .bar-label { width: 110px; font-size: 12px; color: #cbd5e1; flex-shrink: 0; }
        .bar-chart .bar-track { flex: 1; height: 22px; background: #0f172a; border-radius: 6px; overflow: hidden; }
        .bar-chart .bar-fill {
            height: 100%; border-radius: 6px; transition: width 0.8s ease;
            display: flex; align-items: center; padding-left: 8px;
            font-size: 11px; font-weight: 600; color: #fff; min-width: fit-content;
        }
        .bar-chart .bar-value { width: 30px; text-align: right; font-size: 13px; font-weight: 700; color: #f8fafc; flex-shrink: 0; }
        .status-dist { display: flex; gap: 10px; flex-wrap: wrap; }
        .status-chip {
            display: flex; align-items: center; gap: 8px;
            background: #0f172a; padding: 10px 14px; border-radius: 10px;
            flex: 1; min-width: 120px;
        }
        .status-chip .dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .status-chip .info { display: flex; flex-direction: column; }
        .status-chip .info .val { font-size: 18px; font-weight: 700; }
        .status-chip .info .lbl { font-size: 10px; color: #94a3b8; text-transform: uppercase; }

        .table-section {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; overflow: hidden; margin-bottom: 24px;
        }
        .table-section h2 {
            padding: 14px 20px; font-size: 15px; font-weight: 600;
            border-bottom: 1px solid #334155; color: #f8fafc;
        }
        table { width: 100%; border-collapse: collapse; }
        thead th {
            background: #0f172a; padding: 10px 14px; text-align: center;
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
            color: #94a3b8; font-weight: 600;
        }
        thead th:first-child { text-align: left; padding-left: 20px; }
        tbody td { padding: 10px 14px; text-align: center; font-size: 13px; border-bottom: 1px solid #1e293b; }
        tbody td:first-child { text-align: left; padding-left: 20px; font-weight: 600; color: #f8fafc; }
        tbody tr { background: #1e293b; transition: background 0.15s; }
        tbody tr:nth-child(even) { background: #172033; }
        tbody tr:hover { background: #253449; }
        tbody tr.total-row { background: #0f172a; font-weight: 700; border-top: 2px solid #334155; }
        tbody tr.total-row td { color: #60a5fa; font-size: 14px; }
        .badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
        .badge-open { background: #7f1d1d; color: #fca5a5; }
        .badge-progress { background: #78350f; color: #fde68a; }
        .badge-reopened { background: #7c2d12; color: #fdba74; }
        .badge-review { background: #312e81; color: #c4b5fd; }
        .badge-accepted { background: #064e3b; color: #6ee7b7; }
        .badge-parked { background: #1e293b; color: #94a3b8; border: 1px solid #475569; }

        /* ========== CHATBOT TAB ========== */
        .chatbot-layout {
            flex: 1; display: flex; flex-direction: column;
            max-width: 900px; width: 100%; margin: 0 auto; padding: 0;
        }
        .chat-header-bar {
            background: #1e293b; border-bottom: 1px solid #334155;
            padding: 16px 24px;
            display: flex; align-items: center; gap: 12px;
        }
        .chat-header-bar .bot-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; flex-shrink: 0;
        }
        .chat-header-bar .bot-info h3 { font-size: 15px; font-weight: 600; color: #f8fafc; }
        .chat-header-bar .bot-info p { font-size: 12px; color: #94a3b8; }

        .chat-messages {
            flex: 1; overflow-y: auto; padding: 20px 24px;
            display: flex; flex-direction: column; gap: 16px;
        }
        .chat-msg { display: flex; gap: 10px; max-width: 85%; animation: fadeIn 0.3s ease; }
        .chat-msg.bot { align-self: flex-start; }
        .chat-msg.user { align-self: flex-end; flex-direction: row-reverse; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .chat-msg .avatar {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0;
        }
        .chat-msg.bot .avatar { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .chat-msg.user .avatar { background: #475569; }
        .chat-msg .bubble {
            padding: 12px 16px; border-radius: 16px;
            font-size: 14px; line-height: 1.5;
        }
        .chat-msg.bot .bubble { background: #1e293b; border: 1px solid #334155; border-top-left-radius: 4px; }
        .chat-msg.user .bubble { background: #1e40af; border-top-right-radius: 4px; }
        .chat-msg .bubble table { margin-top: 8px; font-size: 12px; }
        .chat-msg .bubble table th { padding: 4px 8px; background: #0f172a; color: #94a3b8; font-size: 10px; text-transform: uppercase; }
        .chat-msg .bubble table td { padding: 4px 8px; border-bottom: 1px solid #334155; }
        .chat-msg .bubble .inline-badge { display: inline-block; padding: 1px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; margin: 1px 2px; }

        .quick-actions {
            padding: 12px 24px; display: flex; gap: 8px; flex-wrap: wrap;
            border-top: 1px solid #1e293b;
        }
        .quick-btn {
            padding: 8px 14px; border-radius: 20px; font-size: 12px;
            background: #1e293b; border: 1px solid #334155; color: #94a3b8;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .quick-btn:hover { background: #253449; color: #e2e8f0; border-color: #60a5fa; }

        .chat-input-area {
            padding: 16px 24px; border-top: 1px solid #334155;
            background: #1e293b; display: flex; gap: 10px; align-items: center;
        }
        .chat-input {
            flex: 1; padding: 12px 16px; border-radius: 12px;
            border: 1px solid #334155; background: #0f172a; color: #e2e8f0;
            font-size: 14px; outline: none; font-family: inherit;
        }
        .chat-input:focus { border-color: #60a5fa; }
        .chat-input::placeholder { color: #475569; }
        .chat-send {
            width: 44px; height: 44px; border-radius: 12px;
            background: #2563eb; border: none; color: #fff;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-size: 18px; transition: background 0.2s;
            flex-shrink: 0;
        }
        .chat-send:hover { background: #3b82f6; }
        .chat-send:disabled { background: #334155; cursor: not-allowed; }

        .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
        .typing-indicator span {
            width: 8px; height: 8px; border-radius: 50%; background: #475569;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* ========== INSIGHTS TAB ========== */
        .insights-container { max-width: 1200px; margin: 0 auto; padding: 24px; width: 100%; }
        .insights-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .insight-card {
            background: #1e293b; border: 1px solid #334155; border-radius: 12px;
            padding: 20px;
        }
        .insight-card h3 { font-size: 14px; font-weight: 600; color: #f8fafc; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .insight-card .insight-icon { font-size: 18px; }
        .insight-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #0f172a;
            font-size: 13px;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-item .label { color: #cbd5e1; }
        .insight-item .value { font-weight: 700; }
        .insight-item .value.red { color: #f87171; }
        .insight-item .value.yellow { color: #fbbf24; }
        .insight-item .value.green { color: #34d399; }
        .insight-item .value.blue { color: #60a5fa; }
        .alert-banner {
            background: linear-gradient(135deg, #7f1d1d, #991b1b);
            border: 1px solid #dc2626; border-radius: 12px;
            padding: 16px 20px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 12px;
        }
        .alert-banner .alert-icon { font-size: 24px; }
        .alert-banner .alert-text h4 { font-size: 14px; font-weight: 600; color: #fca5a5; }
        .alert-banner .alert-text p { font-size: 12px; color: #fca5a5; opacity: 0.8; }

        /* ========== TASK DASHBOARD TAB ========== */
        .task-dashboard-container { max-width: 1400px; margin: 0 auto; padding: 24px; width: 100%; }
        .task-summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .task-summary-cards .card { text-align: center; }
        .task-filters {
            display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;
        }
        .task-filters select {
            background: #1e293b; color: #e2e8f0; border: 1px solid #334155;
            border-radius: 8px; padding: 8px 12px; font-size: 13px;
            cursor: pointer; min-width: 150px;
        }
        .task-filters select:focus { outline: none; border-color: #60a5fa; }
        .task-table-wrapper {
            background: #1e293b; border: 1px solid #334155; border-radius: 12px;
            overflow-x: auto; padding: 0;
        }
        .task-table {
            width: 100%; border-collapse: collapse; font-size: 13px;
        }
        .task-table thead th {
            position: sticky; top: 0; background: #0f172a;
            padding: 12px 10px; text-align: left; font-weight: 600;
            color: #94a3b8; border-bottom: 2px solid #334155;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; user-select: none;
        }
        .task-table thead th:hover { color: #60a5fa; }
        .task-table tbody tr { border-bottom: 1px solid #1e293b; transition: background 0.15s; }
        .task-table tbody tr:hover { background: #334155; }
        .task-table tbody td {
            padding: 10px; color: #cbd5e1; white-space: nowrap;
        }
        .task-table .key-link { color: #60a5fa; font-weight: 600; text-decoration: none; }
        .task-table .key-link:hover { text-decoration: underline; }
        .task-table .summary-cell { white-space: normal; max-width: 300px; word-wrap: break-word; }
        .task-status-badge {
            padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
            display: inline-block;
        }
        .task-status-badge.open { background: #7f1d1d; color: #fca5a5; }
        .task-status-badge.in-progress { background: #78350f; color: #fde68a; }
        .task-status-badge.closed { background: #064e3b; color: #6ee7b7; }
        .task-status-badge.dev-complete { background: #1e3a5f; color: #93c5fd; }
        .task-status-badge.ready-for-test { background: #312e81; color: #c4b5fd; }
        .task-status-badge.on-hold { background: #44403c; color: #d6d3d1; }
        .task-status-badge.other { background: #334155; color: #94a3b8; }
        .eta-overdue { color: #f87171; font-weight: 600; }
        .eta-upcoming { color: #fbbf24; }
        .eta-future { color: #34d399; }
        .eta-blank { color: #475569; font-style: italic; }
        .task-count-badge { font-size: 11px; color: #94a3b8; margin-top: 4px; }

        /* ========== RELEASE DASHBOARD ========== */
        .release-card {
            background: #1e293b; border: 1px solid #334155; border-radius: 12px;
            padding: 20px; margin-bottom: 16px;
        }
        .release-card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            flex-wrap: wrap; gap: 8px; margin-bottom: 10px;
        }
        .release-card-title { display: flex; align-items: center; gap: 12px; }
        .release-card-title h3 { margin: 0; color: #f1f5f9; font-size: 16px; }
        .release-card-meta { display: flex; align-items: center; gap: 16px; font-size: 13px; color: #94a3b8; }
        .release-date { font-style: italic; }
        .release-total { font-weight: 600; }
        .release-badge {
            display: inline-block; padding: 3px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; text-transform: uppercase;
        }
        .release-badge.released { background: #064e3b; color: #34d399; }
        .release-badge.unreleased { background: #7c2d12; color: #fb923c; }
        .release-desc { color: #94a3b8; font-size: 12px; margin-bottom: 10px; font-style: italic; }
        .release-breakdown { font-size: 13px; margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
        .release-statuses { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .release-issues-toggle {
            cursor: pointer; color: #60a5fa; font-size: 13px; padding: 6px 0;
            user-select: none; display: flex; align-items: center; gap: 6px;
        }
        .release-issues-toggle:hover { text-decoration: underline; }
        .toggle-icon { font-size: 10px; transition: transform 0.2s; display: inline-block; }
        .toggle-icon.open { transform: rotate(90deg); }
        .release-issues-table { display: none; margin-top: 8px; }
        .release-issues-table.show { display: block; }

        /* ========== SETTINGS & REFRESH STATUS ========== */
        .btn-settings {
            background: none; border: none; color: #94a3b8;
            cursor: pointer; font-size: 16px; padding: 4px 8px;
            border-radius: 6px; transition: all 0.2s;
        }
        .btn-settings:hover { color: #e2e8f0; background: rgba(255,255,255,0.1); }
        .settings-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .settings-overlay.active { display: flex; }
        .settings-modal {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 24px; width: 480px; max-width: 90vw;
        }
        .settings-modal h3 { font-size: 16px; margin-bottom: 16px; color: #f8fafc; }
        .settings-modal label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 6px; }
        .settings-modal input[type="password"] {
            width: 100%; padding: 8px 12px; background: #0f172a; border: 1px solid #334155;
            border-radius: 8px; color: #e2e8f0; font-size: 13px; font-family: monospace;
            box-sizing: border-box;
        }
        .settings-modal .help-text { font-size: 11px; color: #64748b; margin-top: 6px; line-height: 1.5; }
        .settings-modal .btn-row { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }
        .settings-modal .btn-save {
            background: #1e40af; color: #fff; border: none; padding: 8px 18px;
            border-radius: 8px; cursor: pointer; font-size: 13px;
        }
        .settings-modal .btn-save:hover { background: #2563eb; }
        .settings-modal .btn-cancel {
            background: #334155; color: #e2e8f0; border: none; padding: 8px 18px;
            border-radius: 8px; cursor: pointer; font-size: 13px;
        }
        .settings-modal .btn-clear {
            background: #7f1d1d; color: #fca5a5; border: none; padding: 8px 14px;
            border-radius: 8px; cursor: pointer; font-size: 12px; margin-right: auto;
        }
        .settings-modal .pat-status { font-size: 12px; margin-bottom: 12px; padding: 8px 12px; border-radius: 6px; }
        .settings-modal .pat-status.configured { background: #064e3b; color: #6ee7b7; }
        .settings-modal .pat-status.not-configured { background: #7f1d1d; color: #fca5a5; }
        .refresh-status {
            font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 6px;
        }
        .refresh-status .mini-spinner {
            width: 12px; height: 12px; border: 2px solid #334155;
            border-top-color: #60a5fa; border-radius: 50%;
            animation: spin 0.8s linear infinite; display: inline-block;
        }

        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(15,23,42,0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; flex-direction: column; gap: 16px;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #334155;
            border-top-color: #60a5fa; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-banner {
            background: #7f1d1d; color: #fca5a5; padding: 14px 20px;
            border-radius: 8px; margin-bottom: 16px; display: none;
        }

        /* Footer */
        .footer { text-align: center; padding: 16px; color: #475569; font-size: 11px; flex-shrink: 0; }

        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid, .insights-grid { grid-template-columns: 1fr; }
            .header { padding: 12px 16px; }
            .header h1 { font-size: 16px; }
            .nav-tab { padding: 10px 14px; font-size: 13px; }
            .chat-msg { max-width: 95%; }
        }

        /* Btn refresh */
        .btn-refresh {
            background: #1e40af; color: #fff; border: none;
            padding: 6px 14px; border-radius: 8px; cursor: pointer;
            font-size: 12px; font-weight: 500; transition: background 0.2s;
        }
        .btn-refresh:hover { background: #2563eb; }
        .btn-refresh:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div style="color: #94a3b8; font-size: 14px;">Loading dashboard data...</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div>
            <h1>VF Bug Health <span>- Dashboard & Chatbot</span></h1>
        </div>
        <div class="header-meta">
            <span><span class="status-dot"></span> Live</span>
            <span id="lastUpdated">--</span>
            <span id="refreshStatus" class="refresh-status"></span>
            <button class="btn-refresh" id="refreshBtn" onclick="handleRefresh()">Refresh</button>
            <button class="btn-settings" id="settingsBtn" onclick="openSettings()" title="Configure GitHub PAT for live refresh">&#x2699;</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
        <div class="settings-modal">
            <h3>&#x2699; Dashboard Settings</h3>
            <div id="patStatus" class="pat-status not-configured">No GitHub PAT configured</div>
            <label for="patInput">GitHub Personal Access Token</label>
            <input type="password" id="patInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
            <div class="help-text">
                Required to trigger live Jira data fetch via GitHub Actions.<br>
                <b>Steps:</b> GitHub &rarr; Settings &rarr; Developer settings &rarr; Personal access tokens &rarr; Fine-grained tokens<br>
                <b>Repository:</b> sunilk9898/vf-bug-dashboard-chatbot<br>
                <b>Permission:</b> Actions (Read and Write)<br><br>
                Token is stored only in your browser's localStorage and never sent anywhere except GitHub API.
            </div>
            <div class="btn-row">
                <button class="btn-clear" onclick="clearPat()">Clear Token</button>
                <button class="btn-cancel" onclick="closeSettings()">Cancel</button>
                <button class="btn-save" onclick="savePat()">Save</button>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="dashboard">
            <span class="tab-icon">&#x1f4ca;</span> Bug Dashboard
        </button>
        <button class="nav-tab" data-tab="tasks">
            <span class="tab-icon">&#x2611;</span> Task Dashboard
        </button>
        <button class="nav-tab" data-tab="chatbot">
            <span class="tab-icon">&#x1f4ac;</span> Chatbot
        </button>
        <!-- Release Dashboard tab hidden until fixVersions are configured in Jira
        <button class="nav-tab" data-tab="releases">
            <span class="tab-icon">&#x1f680;</span> Release Dashboard
        </button>
        -->
        <button class="nav-tab" data-tab="insights" style="margin-left:auto">
            <span class="tab-icon">&#x1f4a1;</span> Quality Analytics
        </button>
    </div>

    <div class="main-content">
        <!-- ========== DASHBOARD TAB ========== -->
        <div class="tab-panel active" id="tab-dashboard">
            <div class="dashboard-container">
                <div class="error-banner" id="errorBanner"></div>
                <div class="summary-cards" id="summaryCards"></div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Status Distribution (All Platforms)</h3>
                        <div class="status-dist" id="statusDist"></div>
                    </div>
                    <div class="chart-card">
                        <h3>Platform Bug Count</h3>
                        <div class="bar-chart" id="platformChart"></div>
                    </div>
                </div>
                <div class="table-section">
                    <h2>Platform x Status Breakdown</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Platform</th>
                                <th>Open</th>
                                <th>In Progress</th>
                                <th>Reopened</th>
                                <th>In Review</th>
                                <th>Issue Accepted</th>
                                <th>Parked</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <!-- Bug Details Section -->
                <div class="table-section" style="margin-top:24px">
                    <h2>Individual Bug Details</h2>
                    <div class="task-filters" id="bugFilters">
                        <select id="bugStatusFilter" onchange="renderBugDetails()">
                            <option value="all">All Statuses</option>
                        </select>
                        <select id="bugPlatformFilter" onchange="renderBugDetails()">
                            <option value="all">All Platforms</option>
                        </select>
                        <select id="bugAssigneeFilter" onchange="renderBugDetails()">
                            <option value="all">All Assignees</option>
                        </select>
                        <select id="bugPriorityFilter" onchange="renderBugDetails()">
                            <option value="all">All Priorities</option>
                        </select>
                        <select id="bugSprintFilter" onchange="renderBugDetails()">
                            <option value="all">All Sprints</option>
                        </select>
                    </div>
                    <div class="task-table-wrapper" id="bugDetailTable">
                        <p style="color:#94a3b8;text-align:center;padding:40px;">Loading bug details...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== TASK DASHBOARD TAB ========== -->
        <div class="tab-panel" id="tab-tasks">
            <div class="task-dashboard-container">
                <div class="task-summary-cards" id="taskSummaryCards"></div>
                <div class="task-filters" id="taskFilters">
                    <select id="taskStatusFilter" onchange="renderTaskDashboard()">
                        <option value="all">All Statuses</option>
                    </select>
                    <select id="taskPlatformFilter" onchange="renderTaskDashboard()">
                        <option value="all">All Platforms</option>
                    </select>
                    <select id="taskAssigneeFilter" onchange="renderTaskDashboard()">
                        <option value="all">All Assignees</option>
                    </select>
                    <select id="taskSprintFilter" onchange="renderTaskDashboard()">
                        <option value="all">All Sprints</option>
                    </select>
                </div>
                <div class="task-table-wrapper" id="taskTableArea">
                    <p style="color:#94a3b8;text-align:center;padding:40px;">Loading task data...</p>
                </div>
            </div>
        </div>

        <!-- ========== INSIGHTS TAB ========== -->
        <div class="tab-panel" id="tab-insights">
            <div class="insights-container">
                <div id="alertArea"></div>
                <div class="insights-grid" id="insightsGrid"></div>
            </div>
        </div>

        <!-- ========== CHATBOT TAB ========== -->
        <div class="tab-panel" id="tab-chatbot">
            <div class="chatbot-layout">
                <div class="chat-header-bar">
                    <div class="bot-avatar">&#x1f916;</div>
                    <div class="bot-info">
                        <h3>VZY Jira Assistant</h3>
                        <p>Ask me about bugs, tasks, sprint status & more</p>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="quick-actions" id="quickActions">
                    <button class="quick-btn" onclick="askBot('Bugs created today')">Today's Bugs</button>
                    <button class="quick-btn" onclick="askBot('Bugs from last 7 days')">Recent Bugs (7d)</button>
                    <button class="quick-btn" onclick="askBot('Show bug summary')">Bug Summary</button>
                    <button class="quick-btn" onclick="askBot('Show open bug tickets')">Open Tickets</button>
                    <button class="quick-btn" onclick="askBot('Show in progress bug tickets')">In Progress Tickets</button>
                    <button class="quick-btn" onclick="askBot('Show high priority bugs')">High Priority</button>
                    <button class="quick-btn" onclick="askBot('Show priority breakdown')">Priority Breakdown</button>
                    <button class="quick-btn" onclick="askBot('Show assignee workload')">Assignee Workload</button>
                    <button class="quick-btn" onclick="askBot('Sprint status')">Sprint Status</button>
                    <button class="quick-btn" onclick="askBot('Show all IOS tickets raised so far')">All IOS Tickets</button>
                    <button class="quick-btn" onclick="askBot('Show reopened bug tickets')">Reopened Tickets</button>
                    <button class="quick-btn" onclick="askBot('Compare platforms')">Compare Platforms</button>
                    <button class="quick-btn" onclick="askBot('Show tasks')">Tasks</button>
                    <button class="quick-btn" onclick="askBot('Critical platforms')">Critical Platforms</button>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput"
                           placeholder="Ask about bugs, tasks, sprint status..."
                           onkeydown="if(event.key==='Enter')sendMessage()">
                    <button class="chat-send" id="chatSendBtn" onclick="sendMessage()">&#x27A4;</button>
                </div>
            </div>
        </div>

        <!-- ========== RELEASE DASHBOARD TAB ========== -->
        <div class="tab-panel" id="tab-releases">
            <div class="task-dashboard-container">
                <div class="task-summary-cards" id="releaseSummaryCards"></div>
                <div class="task-filters" id="releaseFilters">
                    <select id="releaseStatusFilter" onchange="renderReleaseDashboard()">
                        <option value="all">All Releases</option>
                        <option value="unreleased">Unreleased Only</option>
                        <option value="released">Released Only</option>
                    </select>
                    <select id="releaseSortFilter" onchange="renderReleaseDashboard()">
                        <option value="name">Sort by Name</option>
                        <option value="date">Sort by Release Date</option>
                        <option value="issues">Sort by Issue Count</option>
                    </select>
                </div>
                <div id="releaseContent">
                    <p style="color:#94a3b8;text-align:center;padding:40px;">Loading release data...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        VF Bug Health Dashboard & Chatbot | Data sourced from Jira (VZY Project) | Auto-refreshes every 5 minutes
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            JIRA_DOMAIN: 'hbeindia.atlassian.net',
            JIRA_EMAIL: '',
            JIRA_API_TOKEN: '',
            PROJECT_KEY: 'VZY',
            USE_LIVE_API: false,
            AUTO_REFRESH_MS: 300000,
            GITHUB_OWNER: 'sunilk9898',
            GITHUB_REPO: 'vf-bug-dashboard-chatbot',
            GITHUB_WORKFLOW_ID: 232803910,
            WORKFLOW_POLL_INTERVAL_MS: 5000,
            WORKFLOW_TIMEOUT_MS: 180000
        };

        // ============================================
        // GITHUB PAT MANAGEMENT
        // ============================================
        const PAT_STORAGE_KEY = 'vf_dashboard_github_pat';

        function getStoredPat() {
            return localStorage.getItem(PAT_STORAGE_KEY);
        }

        function openSettings() {
            const overlay = document.getElementById('settingsOverlay');
            const patInput = document.getElementById('patInput');
            const patStatus = document.getElementById('patStatus');
            const stored = getStoredPat();
            patInput.value = '';
            if (stored) {
                patStatus.className = 'pat-status configured';
                patStatus.textContent = 'PAT configured (ending ...' + stored.slice(-4) + ')';
            } else {
                patStatus.className = 'pat-status not-configured';
                patStatus.textContent = 'No GitHub PAT configured';
            }
            overlay.classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsOverlay').classList.remove('active');
        }

        function savePat() {
            const val = document.getElementById('patInput').value.trim();
            if (!val) { alert('Please enter a GitHub PAT'); return; }
            if (!val.startsWith('ghp_') && !val.startsWith('github_pat_')) {
                alert('Token should start with "ghp_" or "github_pat_". Please check your token.');
                return;
            }
            localStorage.setItem(PAT_STORAGE_KEY, val);
            closeSettings();
        }

        function clearPat() {
            if (confirm('Remove stored GitHub PAT?')) {
                localStorage.removeItem(PAT_STORAGE_KEY);
                closeSettings();
            }
        }

        // ============================================
        // GITHUB ACTIONS WORKFLOW TRIGGER
        // ============================================
        function setRefreshStatus(html) {
            document.getElementById('refreshStatus').innerHTML = html;
        }

        function clearRefreshStatus() {
            document.getElementById('refreshStatus').innerHTML = '';
        }

        async function triggerWorkflow(pat) {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_OWNER}/${CONFIG.GITHUB_REPO}/actions/workflows/${CONFIG.GITHUB_WORKFLOW_ID}/dispatches`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${pat}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ref: 'main' }),
            });
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`Workflow dispatch failed (${response.status}): ${errText}`);
            }
        }

        async function findLatestRun(pat) {
            await new Promise(r => setTimeout(r, 3000));
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_OWNER}/${CONFIG.GITHUB_REPO}/actions/workflows/${CONFIG.GITHUB_WORKFLOW_ID}/runs?per_page=1&branch=main`;
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${pat}`,
                    'Accept': 'application/vnd.github.v3+json',
                },
            });
            if (!response.ok) throw new Error(`Failed to fetch runs (${response.status})`);
            const data = await response.json();
            if (!data.workflow_runs || data.workflow_runs.length === 0) throw new Error('No workflow runs found');
            return data.workflow_runs[0];
        }

        async function pollWorkflowCompletion(pat, runId) {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_OWNER}/${CONFIG.GITHUB_REPO}/actions/runs/${runId}`;
            const startTime = Date.now();
            while (Date.now() - startTime < CONFIG.WORKFLOW_TIMEOUT_MS) {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json',
                    },
                });
                if (!response.ok) throw new Error(`Failed to check run status (${response.status})`);
                const run = await response.json();
                if (run.status === 'completed') {
                    if (run.conclusion === 'success') return true;
                    throw new Error(`Workflow finished with conclusion: ${run.conclusion}`);
                }
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                setRefreshStatus(`<span class="mini-spinner"></span> Fetching from Jira (${elapsed}s)...`);
                await new Promise(r => setTimeout(r, CONFIG.WORKFLOW_POLL_INTERVAL_MS));
            }
            throw new Error('Workflow timed out after ' + (CONFIG.WORKFLOW_TIMEOUT_MS / 1000) + 's');
        }

        async function handleRefresh() {
            const pat = getStoredPat();
            const btn = document.getElementById('refreshBtn');

            if (!pat) {
                const useCached = confirm(
                    'No GitHub PAT configured.\n\n' +
                    'Without a PAT, Refresh only reloads cached data (not fresh from Jira).\n\n' +
                    'Click OK to reload cached data, or Cancel to configure your PAT in Settings (gear icon).'
                );
                if (useCached) { loadData(); } else { openSettings(); }
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Fetching...';
            try {
                setRefreshStatus('<span class="mini-spinner"></span> Triggering Jira fetch...');
                await triggerWorkflow(pat);

                setRefreshStatus('<span class="mini-spinner"></span> Waiting for workflow...');
                const run = await findLatestRun(pat);

                await pollWorkflowCompletion(pat, run.id);

                setRefreshStatus('<span class="mini-spinner"></span> Deploying fresh data...');
                await new Promise(r => setTimeout(r, 10000));

                setRefreshStatus('Reloading data...');
                await loadData();

                setRefreshStatus('<span style="color:#22c55e">&#x2713; Data refreshed from Jira!</span>');
                setTimeout(clearRefreshStatus, 8000);
            } catch (err) {
                console.error('Workflow trigger error:', err);
                setRefreshStatus(`<span style="color:#f87171">&#x2717; ${err.message}</span>`);
                setTimeout(clearRefreshStatus, 15000);
                if (err.message.includes('401') || err.message.includes('403')) {
                    if (confirm('Authentication failed. Your PAT may be expired or invalid.\n\nOpen settings to update it?')) {
                        openSettings();
                    }
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh';
            }
        }

        const STATUSES = ['OPEN', 'IN PROGRESS', 'REOPENED', 'IN REVIEW', 'ISSUE ACCEPTED', 'PARKED'];
        const DEFAULT_PLATFORMS = ['ANDROID', 'ATV', 'CMS Adaptor', 'CMS Dashboard', 'DishIT', 'IOS', 'LG_TV', 'SAM_TV', 'WEB'];
        let PLATFORMS = [...DEFAULT_PLATFORMS];

        const STATUS_COLORS = {
            'OPEN': '#ef4444', 'IN PROGRESS': '#f59e0b', 'REOPENED': '#f97316',
            'IN REVIEW': '#8b5cf6', 'ISSUE ACCEPTED': '#10b981', 'PARKED': '#64748b'
        };
        const STATUS_BADGE_CLASS = {
            'OPEN': 'badge-open', 'IN PROGRESS': 'badge-progress', 'REOPENED': 'badge-reopened',
            'IN REVIEW': 'badge-review', 'ISSUE ACCEPTED': 'badge-accepted', 'PARKED': 'badge-parked'
        };

        let dashboardData = null;
        let allIssues = null;

        // ============================================
        // STATIC FALLBACK DATA
        // ============================================
        function getStaticData() {
            return {
                'ANDROID':        { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 1, 'IN REVIEW': 1, 'ISSUE ACCEPTED': 1, 'PARKED': 1 },
                'ATV':            { 'OPEN': 0, 'IN PROGRESS': 1, 'REOPENED': 1, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 1, 'PARKED': 0 },
                'CMS Adaptor':    { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 1, 'PARKED': 0 },
                'CMS Dashboard':  { 'OPEN': 0, 'IN PROGRESS': 1, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 0, 'PARKED': 0 },
                'DishIT':         { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 0, 'PARKED': 1 },
                'IOS':            { 'OPEN': 0, 'IN PROGRESS': 0, 'REOPENED': 0, 'IN REVIEW': 1, 'ISSUE ACCEPTED': 0, 'PARKED': 1 },
                'LG_TV':          { 'OPEN': 0, 'IN PROGRESS': 2, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 0, 'PARKED': 0 },
                'SAM_TV':         { 'OPEN': 0, 'IN PROGRESS': 1, 'REOPENED': 0, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 1, 'PARKED': 0 },
                'WEB':            { 'OPEN': 2, 'IN PROGRESS': 0, 'REOPENED': 1, 'IN REVIEW': 0, 'ISSUE ACCEPTED': 2, 'PARKED': 0 },
            };
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                if (tab.dataset.tab === 'chatbot' && document.getElementById('chatMessages').children.length === 0) {
                    initChatbot();
                }
                if (tab.dataset.tab === 'insights') {
                    renderInsights();
                }
                if (tab.dataset.tab === 'tasks') {
                    renderTaskDashboard();
                }
                if (tab.dataset.tab === 'releases') {
                    renderReleaseDashboard();
                }
            });
        });

        // ============================================
        // FETCH DATA
        // ============================================
        async function fetchDataJson() {
            const response = await fetch(`data.json?t=${Date.now()}`);
            if (!response.ok) throw new Error(`data.json not found (${response.status})`);
            return await response.json();
        }

        async function fetchDetailedData() {
            try {
                const response = await fetch(`detailed_data.json?t=${Date.now()}`);
                if (!response.ok) return null;
                return await response.json();
            } catch { return null; }
        }

        // ============================================
        // RENDER DASHBOARD
        // ============================================
        function renderDashboard(data) {
            dashboardData = data;
            // Dynamically detect platforms from data keys
            PLATFORMS = Object.keys(data).filter(k => typeof data[k] === 'object' && data[k] !== null && !Array.isArray(data[k]) && STATUSES.some(s => s in data[k]));
            const totals = {};
            STATUSES.forEach(s => totals[s] = 0);
            let grandTotal = 0;
            const platformTotals = {};

            PLATFORMS.forEach(p => {
                let pTotal = 0;
                STATUSES.forEach(s => {
                    const val = data[p]?.[s] || 0;
                    totals[s] += val;
                    pTotal += val;
                });
                platformTotals[p] = pTotal;
                grandTotal += pTotal;
            });

            // Summary cards
            const cardData = [
                { label: 'Total Issues', value: grandTotal, cls: 'total' },
                { label: 'Open', value: totals['OPEN'], cls: 'open' },
                { label: 'In Progress', value: totals['IN PROGRESS'], cls: 'progress' },
                { label: 'Reopened', value: totals['REOPENED'], cls: 'open' },
                { label: 'In Review', value: totals['IN REVIEW'], cls: 'review' },
                { label: 'Accepted', value: totals['ISSUE ACCEPTED'], cls: 'accepted' },
                { label: 'Parked', value: totals['PARKED'], cls: 'parked' }
            ];
            document.getElementById('summaryCards').innerHTML = cardData.map(c => `
                <div class="card ${c.cls}"><div class="number">${c.value}</div><div class="label">${c.label}</div></div>
            `).join('');

            // Status chips
            document.getElementById('statusDist').innerHTML = STATUSES.map(s => `
                <div class="status-chip">
                    <div class="dot" style="background: ${STATUS_COLORS[s]}"></div>
                    <div class="info"><span class="val">${totals[s]}</span><span class="lbl">${s}</span></div>
                </div>
            `).join('');

            // Bar chart
            const maxTotal = Math.max(...Object.values(platformTotals), 1);
            document.getElementById('platformChart').innerHTML = PLATFORMS
                .sort((a, b) => platformTotals[b] - platformTotals[a])
                .map(p => {
                    const pct = (platformTotals[p] / maxTotal * 100).toFixed(0);
                    const color = platformTotals[p] >= 4 ? '#ef4444' : platformTotals[p] >= 2 ? '#f59e0b' : '#10b981';
                    return `<div class="bar-row">
                        <div class="bar-label">${p}</div>
                        <div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,5)}%;background:${color}">${platformTotals[p]}</div></div>
                        <div class="bar-value">${platformTotals[p]}</div>
                    </div>`;
                }).join('');

            // Table
            let tableHTML = '';
            PLATFORMS.forEach(p => {
                let rowTotal = platformTotals[p];
                tableHTML += `<tr><td>${p}</td>
                    ${STATUSES.map(s => {
                        const val = data[p]?.[s] || 0;
                        return `<td>${val > 0 ? `<span class="badge ${STATUS_BADGE_CLASS[s]}">${val}</span>` : '<span style="color:#475569">0</span>'}</td>`;
                    }).join('')}
                    <td><strong style="color:${rowTotal >= 4 ? '#f87171' : rowTotal >= 2 ? '#fbbf24' : '#34d399'}">${rowTotal}</strong></td>
                </tr>`;
            });
            tableHTML += `<tr class="total-row"><td>Total Unique Issues:</td>
                ${STATUSES.map(s => `<td>${totals[s]}</td>`).join('')}
                <td>${grandTotal}</td></tr>`;
            document.getElementById('tableBody').innerHTML = tableHTML;
            document.getElementById('lastUpdated').textContent = `Updated: ${new Date().toLocaleString()}`;
        }

        // ============================================
        // BUG DETAILS TABLE (in Bug Dashboard)
        // ============================================
        let bugSortCol = 'key';
        let bugSortAsc = false;

        function renderBugDetails() {
            if (!allIssues || !allIssues.bugs) {
                document.getElementById('bugDetailTable').innerHTML =
                    '<p style="color:#94a3b8;text-align:center;padding:40px;">Bug detail data is loading...</p>';
                return;
            }

            const ACTIVE_STATUSES = ['Open', 'In Progress', 'Reopened', 'In Review', 'Issue Accepted', 'Parked'];
            const allBugs = allIssues.bugs;
            const activeBugs = allBugs.filter(b => ACTIVE_STATUSES.includes(b.status));

            // Collect unique values
            const statuses = [...new Set(allBugs.map(b => b.status).filter(Boolean))].sort();
            const platforms = [...new Set(allBugs.map(b => b.platform).filter(Boolean))].sort();
            const assignees = [...new Set(allBugs.map(b => b.assignee).filter(Boolean))].sort();
            const priorities = [...new Set(allBugs.map(b => b.priority).filter(Boolean))].sort();
            const sprints = [...new Set(allBugs.map(b => b.sprint).filter(Boolean))].sort();

            // Populate filters
            const sf = document.getElementById('bugStatusFilter');
            const pf = document.getElementById('bugPlatformFilter');
            const af = document.getElementById('bugAssigneeFilter');
            const prf = document.getElementById('bugPriorityFilter');
            const spf = document.getElementById('bugSprintFilter');
            const cs = sf.value, cp = pf.value, ca = af.value, cpr = prf.value, csp = spf.value;

            sf.innerHTML = '<option value="all">All Statuses</option><option value="active" ' + (cs==='active'?'selected':'') + '>Active Only</option>' +
                statuses.map(s => `<option value="${s}" ${s===cs?'selected':''}>${s}</option>`).join('');
            pf.innerHTML = '<option value="all">All Platforms</option>' +
                platforms.map(p => `<option value="${p}" ${p===cp?'selected':''}>${p}</option>`).join('');
            af.innerHTML = '<option value="all">All Assignees</option>' +
                assignees.map(a => `<option value="${a}" ${a===ca?'selected':''}>${escapeHtml(a)}</option>`).join('');
            prf.innerHTML = '<option value="all">All Priorities</option>' +
                priorities.map(p => `<option value="${p}" ${p===cpr?'selected':''}>${p}</option>`).join('');
            spf.innerHTML = '<option value="all">All Sprints</option>' +
                sprints.map(s => `<option value="${s}" ${s===csp?'selected':''}>${escapeHtml(s)}</option>`).join('');

            // Apply filters
            let filtered = allBugs;
            if (cs === 'active') filtered = activeBugs;
            else if (cs !== 'all') filtered = filtered.filter(b => b.status === cs);
            if (cp !== 'all') filtered = filtered.filter(b => b.platform === cp);
            if (ca !== 'all') filtered = filtered.filter(b => b.assignee === ca);
            if (cpr !== 'all') filtered = filtered.filter(b => b.priority === cpr);
            if (csp !== 'all') filtered = filtered.filter(b => b.sprint === csp);

            // Sort
            filtered.sort((a, b) => {
                let va = a[bugSortCol] || '', vb = b[bugSortCol] || '';
                const cmp = va.toString().localeCompare(vb.toString(), undefined, { numeric: true });
                return bugSortAsc ? cmp : -cmp;
            });

            // Build table
            const sortIcon = (col) => bugSortCol === col ? (bugSortAsc ? ' &#9650;' : ' &#9660;') : '';
            const cols = [
                { key: 'key', label: 'Ticket' },
                { key: 'summary', label: 'Summary' },
                { key: 'status', label: 'Status' },
                { key: 'priority', label: 'Priority' },
                { key: 'assignee', label: 'Assignee' },
                { key: 'platform', label: 'Platform' },
                { key: 'sprint', label: 'Sprint' },
                { key: 'created', label: 'Created' },
                { key: 'updated', label: 'Updated' },
            ];

            let html = `<table class="task-table"><thead><tr>`;
            cols.forEach(c => {
                html += `<th onclick="bugSortCol='${c.key}';bugSortAsc=bugSortCol==='${c.key}'?!bugSortAsc:false;renderBugDetails()">${c.label}${sortIcon(c.key)}</th>`;
            });
            html += `</tr></thead><tbody>`;

            const maxRows = 100;
            filtered.slice(0, maxRows).forEach(b => {
                const pColor = b.priority === 'Highest' ? '#ef4444' : b.priority === 'High' ? '#f97316' : b.priority === 'Medium' ? '#fbbf24' : '#94a3b8';
                const statusCls = getTaskStatusClass(b.status);
                html += `<tr>
                    <td><a class="key-link" href="https://hbeindia.atlassian.net/browse/${b.key}" target="_blank">${b.key}</a></td>
                    <td class="summary-cell">${escapeHtml((b.summary || '').substring(0, 80))}</td>
                    <td><span class="task-status-badge ${statusCls}">${b.status}</span></td>
                    <td style="color:${pColor}">${b.priority || '-'}</td>
                    <td style="font-size:12px">${escapeHtml((b.assignee || 'Unassigned').split(' ').slice(0,2).join(' '))}</td>
                    <td style="font-size:12px">${b.platform || '-'}</td>
                    <td style="font-size:11px">${escapeHtml((b.sprint || '-').substring(0, 30))}</td>
                    <td style="font-size:11px;color:#94a3b8">${b.created || '-'}</td>
                    <td style="font-size:11px;color:#94a3b8">${b.updated || '-'}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            html += `<div class="task-count-badge" style="padding:12px;text-align:center">Showing ${Math.min(maxRows, filtered.length)} of ${filtered.length} bugs (${allBugs.length} total).</div>`;
            document.getElementById('bugDetailTable').innerHTML = html;
        }

        // ============================================
        // INSIGHTS TAB - Quality Analytics
        // ============================================
        function renderInsights() {
            if (!dashboardData) return;
            const data = dashboardData;
            const platformTotals = {};
            const totals = {};
            STATUSES.forEach(s => totals[s] = 0);
            let grandTotal = 0;
            PLATFORMS.forEach(p => {
                let pTotal = 0;
                STATUSES.forEach(s => { const v = data[p]?.[s] || 0; totals[s] += v; pTotal += v; });
                platformTotals[p] = pTotal; grandTotal += pTotal;
            });

            // Alerts
            const criticalPlatforms = PLATFORMS.filter(p => platformTotals[p] >= 4);
            const reopenedTotal = totals['REOPENED'] || 0;
            let alertHTML = '';
            if (criticalPlatforms.length > 0) {
                alertHTML += `<div class="alert-banner"><div class="alert-icon">&#x26A0;</div>
                    <div class="alert-text"><h4>Critical Platforms</h4><p>${criticalPlatforms.join(', ')} have 4+ active bugs requiring attention</p></div></div>`;
            }
            if (reopenedTotal >= 3) {
                alertHTML += `<div class="alert-banner" style="background:linear-gradient(135deg,#78350f,#92400e);border-color:#f59e0b;">
                    <div class="alert-icon">&#x1f504;</div><div class="alert-text"><h4>High Reopen Rate</h4><p>${reopenedTotal} bugs have been reopened - review fix quality</p></div></div>`;
            }
            document.getElementById('alertArea').innerHTML = alertHTML;

            // Quality analytics require detailed data
            if (!allIssues || !allIssues.bugs) {
                document.getElementById('insightsGrid').innerHTML = '<p style="color:#94a3b8;text-align:center;padding:40px;">Loading detailed analytics...</p>';
                return;
            }

            const allBugs = allIssues.bugs;
            const now = new Date();
            const ACTIVE = ['Open', 'In Progress', 'Reopened', 'In Review', 'Issue Accepted', 'Parked'];
            const activeBugs = allBugs.filter(b => ACTIVE.includes(b.status));
            const daysSince = (dateStr) => dateStr ? Math.floor((now - new Date(dateStr + 'T00:00:00')) / 86400000) : 0;

            // === 1. BUG AGING ===
            const agingBugs = activeBugs.map(b => ({ ...b, age: daysSince(b.created) })).sort((a, b) => b.age - a.age);
            const avgAge = agingBugs.length ? Math.round(agingBugs.reduce((s, b) => s + b.age, 0) / agingBugs.length) : 0;
            const age7 = agingBugs.filter(b => b.age <= 7).length;
            const age30 = agingBugs.filter(b => b.age > 7 && b.age <= 30).length;
            const age90 = agingBugs.filter(b => b.age > 30 && b.age <= 90).length;
            const age90p = agingBugs.filter(b => b.age > 90).length;
            const ageColor = (d) => d > 90 ? 'red' : d > 30 ? 'yellow' : 'green';

            let agingHTML = `<div class="insight-card" style="grid-column:span 2">
                <h3><span class="insight-icon">&#x23F3;</span> Bug Aging Analysis (${activeBugs.length} active bugs)</h3>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:12px">
                    <div class="insight-item" style="flex-direction:column;text-align:center;border:1px solid #334155;border-radius:8px;padding:8px">
                        <span class="value blue" style="font-size:20px">${avgAge}d</span><span class="label">Avg Age</span></div>
                    <div class="insight-item" style="flex-direction:column;text-align:center;border:1px solid #334155;border-radius:8px;padding:8px">
                        <span class="value green" style="font-size:20px">${age7}</span><span class="label">0-7 days</span></div>
                    <div class="insight-item" style="flex-direction:column;text-align:center;border:1px solid #334155;border-radius:8px;padding:8px">
                        <span class="value green" style="font-size:20px">${age30}</span><span class="label">8-30 days</span></div>
                    <div class="insight-item" style="flex-direction:column;text-align:center;border:1px solid #334155;border-radius:8px;padding:8px">
                        <span class="value yellow" style="font-size:20px">${age90}</span><span class="label">31-90 days</span></div>
                    <div class="insight-item" style="flex-direction:column;text-align:center;border:1px solid #334155;border-radius:8px;padding:8px">
                        <span class="value red" style="font-size:20px">${age90p}</span><span class="label">90+ days</span></div>
                </div>
                <div style="font-size:12px;color:#94a3b8;margin-bottom:8px"><b>Oldest Active Bugs:</b></div>
                <table class="task-table" style="font-size:11px"><thead><tr><th>Ticket</th><th>Summary</th><th>Age</th><th>Status</th><th>Platform</th><th>Assignee</th></tr></thead><tbody>
                ${agingBugs.slice(0, 10).map(b => `<tr>
                    <td><a class="key-link" href="https://hbeindia.atlassian.net/browse/${b.key}" target="_blank">${b.key}</a></td>
                    <td class="summary-cell">${escapeHtml((b.summary||'').substring(0,60))}</td>
                    <td class="${ageColor(b.age)}" style="font-weight:600">${b.age}d</td>
                    <td><span class="task-status-badge ${getTaskStatusClass(b.status)}">${b.status}</span></td>
                    <td>${b.platform||'-'}</td>
                    <td>${escapeHtml((b.assignee||'').split(' ')[0])}</td></tr>`).join('')}
                </tbody></table></div>`;

            // === 2. REOPEN ANALYSIS ===
            const reopenedBugs = allBugs.filter(b => b.status === 'Reopened').map(b => ({ ...b, age: daysSince(b.created) }));
            const reopenByPlatform = {};
            const reopenByAssignee = {};
            reopenedBugs.forEach(b => {
                reopenByPlatform[b.platform] = (reopenByPlatform[b.platform] || 0) + 1;
                reopenByAssignee[b.assignee] = (reopenByAssignee[b.assignee] || 0) + 1;
            });

            let reopenHTML = `<div class="insight-card">
                <h3><span class="insight-icon">&#x1f504;</span> Reopen Analysis (${reopenedBugs.length} bugs)</h3>
                <div style="font-size:12px;color:#94a3b8;margin-bottom:6px"><b>By Platform:</b></div>
                ${Object.entries(reopenByPlatform).sort((a,b)=>b[1]-a[1]).map(([p,c]) =>
                    `<div class="insight-item"><span class="label">${p}</span><span class="value red">${c}</span></div>`).join('')}
                <div style="font-size:12px;color:#94a3b8;margin:8px 0 6px"><b>By Assignee:</b></div>
                ${Object.entries(reopenByAssignee).sort((a,b)=>b[1]-a[1]).map(([a,c]) =>
                    `<div class="insight-item"><span class="label">${escapeHtml(a.split(' ')[0])}</span><span class="value yellow">${c}</span></div>`).join('')}
                ${reopenedBugs.length === 0 ? '<div class="insight-item"><span class="label">No reopened bugs</span><span class="value green">&#x2713;</span></div>' : ''}
            </div>`;

            // === 3. STALE/STUCK BUGS ===
            const staleBugs = activeBugs.map(b => ({ ...b, daysSinceUpdate: daysSince(b.updated) }))
                .filter(b => b.daysSinceUpdate >= 14).sort((a,b) => b.daysSinceUpdate - a.daysSinceUpdate);
            const stale30 = staleBugs.filter(b => b.daysSinceUpdate >= 30);

            let staleHTML = `<div class="insight-card">
                <h3><span class="insight-icon">&#x1f6d1;</span> Stale/Stuck Bugs</h3>
                <div class="insight-item"><span class="label">Not updated in 30+ days</span><span class="value red">${stale30.length}</span></div>
                <div class="insight-item"><span class="label">Not updated in 14-29 days</span><span class="value yellow">${staleBugs.length - stale30.length}</span></div>
                <div class="insight-item"><span class="label">Recently active (&lt;14d)</span><span class="value green">${activeBugs.length - staleBugs.length}</span></div>
                ${staleBugs.length > 0 ? '<div style="font-size:12px;color:#94a3b8;margin:8px 0 4px"><b>Most Stale:</b></div>' : ''}
                ${staleBugs.slice(0, 8).map(b => {
                    const clr = b.daysSinceUpdate >= 30 ? 'red' : 'yellow';
                    return `<div class="insight-item"><span class="label"><a class="key-link" href="https://hbeindia.atlassian.net/browse/${b.key}" target="_blank" style="font-size:11px">${b.key}</a> ${escapeHtml((b.summary||'').substring(0,30))}</span><span class="value ${clr}">${b.daysSinceUpdate}d</span></div>`;
                }).join('')}
            </div>`;

            // === 4. ASSIGNEE WORKLOAD ===
            const assigneeActive = {};
            const assigneeHighPri = {};
            activeBugs.forEach(b => {
                const a = b.assignee || 'Unassigned';
                assigneeActive[a] = (assigneeActive[a] || 0) + 1;
                if (b.priority === 'High' || b.priority === 'Highest') assigneeHighPri[a] = (assigneeHighPri[a] || 0) + 1;
            });
            const sortedAssignees = Object.entries(assigneeActive).sort((a,b) => b[1] - a[1]);

            let assigneeHTML = `<div class="insight-card">
                <h3><span class="insight-icon">&#x1f465;</span> Assignee Workload (Active Bugs)</h3>
                <table class="task-table" style="font-size:12px"><thead><tr><th style="text-align:left">Assignee</th><th>Active</th><th>High/Highest</th><th>Load</th></tr></thead><tbody>
                ${sortedAssignees.slice(0, 15).map(([a, c]) => {
                    const hp = assigneeHighPri[a] || 0;
                    const load = c >= 6 ? '<span class="value red">Overloaded</span>' : c >= 3 ? '<span class="value yellow">High</span>' : '<span class="value green">Normal</span>';
                    return `<tr><td>${escapeHtml(a.split(' ').slice(0,2).join(' '))}</td><td style="text-align:center"><b>${c}</b></td><td style="text-align:center;color:#f97316">${hp || '-'}</td><td style="text-align:center">${load}</td></tr>`;
                }).join('')}
                </tbody></table></div>`;

            // === 5. PRIORITY & RISK ===
            const platformRisk = {};
            activeBugs.forEach(b => {
                const p = b.platform || 'Unknown';
                if (!platformRisk[p]) platformRisk[p] = { high: 0, highest: 0, total: 0, unattended: 0 };
                platformRisk[p].total++;
                if (b.priority === 'High') platformRisk[p].high++;
                if (b.priority === 'Highest') platformRisk[p].highest++;
                if ((b.priority === 'High' || b.priority === 'Highest') && b.status === 'Open') platformRisk[p].unattended++;
            });
            const riskSorted = Object.entries(platformRisk).map(([p, r]) => ({
                platform: p, ...r, score: r.high * 2 + r.highest * 3
            })).sort((a, b) => b.score - a.score);

            let riskHTML = `<div class="insight-card">
                <h3><span class="insight-icon">&#x26A1;</span> Platform Risk Score</h3>
                <div style="font-size:10px;color:#64748b;margin-bottom:8px">Score = (High&#xd7;2) + (Highest&#xd7;3)</div>
                <table class="task-table" style="font-size:12px"><thead><tr><th style="text-align:left">Platform</th><th>Bugs</th><th>High</th><th>Highest</th><th>Unattended</th><th>Risk</th></tr></thead><tbody>
                ${riskSorted.map(r => {
                    const rClr = r.score >= 6 ? 'red' : r.score >= 3 ? 'yellow' : 'green';
                    return `<tr><td>${r.platform}</td><td style="text-align:center">${r.total}</td><td style="text-align:center;color:#f97316">${r.high||'-'}</td><td style="text-align:center;color:#ef4444">${r.highest||'-'}</td><td style="text-align:center;color:#fbbf24">${r.unattended||'-'}</td><td style="text-align:center"><span class="value ${rClr}">${r.score}</span></td></tr>`;
                }).join('')}
                </tbody></table></div>`;

            // === 6. RESOLUTION VELOCITY ===
            const closedBugs = allBugs.filter(b => b.status === 'Closed' && b.created && b.updated);
            const resTimes = closedBugs.map(b => daysSince(b.created) - daysSince(b.updated)).filter(d => d >= 0);
            const avgRes = resTimes.length ? Math.round(resTimes.reduce((s,d) => s + d, 0) / resTimes.length) : 0;
            const resByPlatform = {};
            closedBugs.forEach(b => {
                const p = b.platform || 'Unknown';
                if (!resByPlatform[p]) resByPlatform[p] = { times: [], count: 0 };
                const rt = daysSince(b.created) - daysSince(b.updated);
                if (rt >= 0) { resByPlatform[p].times.push(rt); resByPlatform[p].count++; }
            });
            const resPlatSorted = Object.entries(resByPlatform).map(([p, d]) => ({
                platform: p, avg: d.times.length ? Math.round(d.times.reduce((s,t)=>s+t,0)/d.times.length) : 0, count: d.count
            })).sort((a, b) => a.avg - b.avg);

            let velocityHTML = `<div class="insight-card" style="grid-column:span 2">
                <h3><span class="insight-icon">&#x1f680;</span> Resolution Velocity (${closedBugs.length} closed bugs)</h3>
                <div class="insight-item"><span class="label">Average Resolution Time</span><span class="value blue">${avgRes} days</span></div>
                <div style="font-size:12px;color:#94a3b8;margin:8px 0 6px"><b>By Platform (fastest to slowest):</b></div>
                <table class="task-table" style="font-size:12px"><thead><tr><th style="text-align:left">Platform</th><th>Closed Bugs</th><th>Avg Days</th><th>Speed</th></tr></thead><tbody>
                ${resPlatSorted.map(r => {
                    const spd = r.avg <= 7 ? '<span class="value green">Fast</span>' : r.avg <= 30 ? '<span class="value yellow">Normal</span>' : '<span class="value red">Slow</span>';
                    return `<tr><td>${r.platform}</td><td style="text-align:center">${r.count}</td><td style="text-align:center"><b>${r.avg}d</b></td><td style="text-align:center">${spd}</td></tr>`;
                }).join('')}
                </tbody></table></div>`;

            document.getElementById('insightsGrid').innerHTML = agingHTML + reopenHTML + staleHTML + assigneeHTML + riskHTML + velocityHTML;
        }

        // ============================================
        // TASK DASHBOARD
        // ============================================
        let taskSortCol = 'key';
        let taskSortAsc = false;

        function getTaskStatusClass(status) {
            const s = (status || '').toLowerCase();
            if (s === 'open') return 'open';
            if (s === 'in progress') return 'in-progress';
            if (s === 'closed') return 'closed';
            if (s === 'dev complete') return 'dev-complete';
            if (s === 'ready for test') return 'ready-for-test';
            if (s.includes('hold') || s.includes('parked')) return 'on-hold';
            return 'other';
        }

        function getEtaClass(duedate) {
            if (!duedate) return 'eta-blank';
            const now = new Date();
            const due = new Date(duedate + 'T23:59:59');
            const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return 'eta-overdue';
            if (diffDays <= 3) return 'eta-upcoming';
            return 'eta-future';
        }

        function renderTaskDashboard() {
            if (!allIssues) {
                document.getElementById('taskTableArea').innerHTML =
                    '<p style="color:#94a3b8;text-align:center;padding:40px;">Task data is loading. Please wait...</p>';
                return;
            }

            const tasks = allIssues.tasks || [];
            const subtasks = allIssues.subtasks || [];
            const allTasks = [...tasks, ...subtasks];

            // Collect unique values for filters
            const statuses = [...new Set(allTasks.map(t => t.status).filter(Boolean))].sort();
            const platforms = [...new Set(allTasks.map(t => t.platform).filter(Boolean))].sort();
            const assignees = [...new Set(allTasks.map(t => t.assignee).filter(Boolean))].sort();
            const sprints = [...new Set(allTasks.map(t => t.sprint).filter(Boolean))].sort();

            // Populate filter dropdowns (preserve selection)
            const statusFilter = document.getElementById('taskStatusFilter');
            const platformFilter = document.getElementById('taskPlatformFilter');
            const assigneeFilter = document.getElementById('taskAssigneeFilter');
            const sprintFilter = document.getElementById('taskSprintFilter');

            const curStatus = statusFilter.value;
            const curPlatform = platformFilter.value;
            const curAssignee = assigneeFilter.value;
            const curSprint = sprintFilter.value;

            statusFilter.innerHTML = '<option value="all">All Statuses</option>' +
                statuses.map(s => `<option value="${s}" ${s===curStatus?'selected':''}>${s}</option>`).join('');
            platformFilter.innerHTML = '<option value="all">All Platforms</option>' +
                platforms.map(p => `<option value="${p}" ${p===curPlatform?'selected':''}>${p}</option>`).join('');
            assigneeFilter.innerHTML = '<option value="all">All Assignees</option>' +
                assignees.map(a => `<option value="${a}" ${a===curAssignee?'selected':''}>${escapeHtml(a)}</option>`).join('');
            sprintFilter.innerHTML = '<option value="all">All Sprints</option>' +
                sprints.map(s => `<option value="${s}" ${s===curSprint?'selected':''}>${escapeHtml(s)}</option>`).join('');

            // Apply filters
            let filtered = allTasks;
            if (curStatus !== 'all') filtered = filtered.filter(t => t.status === curStatus);
            if (curPlatform !== 'all') filtered = filtered.filter(t => t.platform === curPlatform);
            if (curAssignee !== 'all') filtered = filtered.filter(t => t.assignee === curAssignee);
            if (curSprint !== 'all') filtered = filtered.filter(t => t.sprint === curSprint);

            // Sort
            filtered.sort((a, b) => {
                let va = a[taskSortCol] || '';
                let vb = b[taskSortCol] || '';
                if (taskSortCol === 'duedate' || taskSortCol === 'created' || taskSortCol === 'updated') {
                    va = va || 'zzzz'; vb = vb || 'zzzz'; // blanks at end
                }
                const cmp = va.toString().localeCompare(vb.toString(), undefined, { numeric: true });
                return taskSortAsc ? cmp : -cmp;
            });

            // Summary cards
            const openCount = allTasks.filter(t => t.status === 'Open').length;
            const inProgressCount = allTasks.filter(t => t.status === 'In Progress').length;
            const devCompleteCount = allTasks.filter(t => t.status === 'Dev Complete').length;
            const readyForTestCount = allTasks.filter(t => t.status === 'Ready For Test').length;
            const closedCount = allTasks.filter(t => t.status === 'Closed').length;
            const onHoldCount = allTasks.filter(t => (t.status || '').toLowerCase().includes('hold') || t.status === 'Parked').length;
            const withEta = allTasks.filter(t => t.duedate).length;
            const overdueCount = allTasks.filter(t => t.duedate && getEtaClass(t.duedate) === 'eta-overdue').length;

            document.getElementById('taskSummaryCards').innerHTML = [
                { label: 'Total Tasks', value: allTasks.length, cls: 'total' },
                { label: 'Open', value: openCount, cls: 'open' },
                { label: 'In Progress', value: inProgressCount, cls: 'progress' },
                { label: 'Dev Complete', value: devCompleteCount, cls: 'review' },
                { label: 'Ready For Test', value: readyForTestCount, cls: 'accepted' },
                { label: 'Closed', value: closedCount, cls: 'parked' },
                { label: 'On Hold', value: onHoldCount, cls: 'parked' },
                { label: 'With ETA', value: withEta, cls: 'total' },
                { label: 'Overdue', value: overdueCount, cls: 'open' },
            ].map(c => `<div class="card ${c.cls}"><div class="number">${c.value}</div><div class="label">${c.label}</div></div>`).join('');

            // Build table
            const sortIcon = (col) => taskSortCol === col ? (taskSortAsc ? ' &#9650;' : ' &#9660;') : '';
            const cols = [
                { key: 'key', label: 'Ticket' },
                { key: 'summary', label: 'Summary' },
                { key: 'type', label: 'Type' },
                { key: 'status', label: 'Status' },
                { key: 'priority', label: 'Priority' },
                { key: 'assignee', label: 'Assignee' },
                { key: 'platform', label: 'Platform' },
                { key: 'sprint', label: 'Sprint' },
                { key: 'duedate', label: 'ETA' },
                { key: 'created', label: 'Created' },
                { key: 'updated', label: 'Updated' },
            ];

            let html = `<table class="task-table"><thead><tr>`;
            cols.forEach(c => {
                html += `<th onclick="taskSortCol='${c.key}';taskSortAsc=taskSortCol==='${c.key}'?!taskSortAsc:false;renderTaskDashboard()">${c.label}${sortIcon(c.key)}</th>`;
            });
            html += `</tr></thead><tbody>`;

            const maxRows = 100;
            const display = filtered.slice(0, maxRows);
            display.forEach(t => {
                const pColor = t.priority === 'Highest' ? '#ef4444' : t.priority === 'High' ? '#f97316' : t.priority === 'Medium' ? '#fbbf24' : '#94a3b8';
                const etaClass = getEtaClass(t.duedate);
                const etaDisplay = t.duedate ? t.duedate : '<span class="eta-blank">-</span>';
                const typeLabel = t.type === 'Sub-Task' ? 'Sub-task' : t.type;
                html += `<tr>
                    <td><a class="key-link" href="https://hbeindia.atlassian.net/browse/${t.key}" target="_blank">${t.key}</a></td>
                    <td class="summary-cell">${escapeHtml((t.summary || '').substring(0, 80))}</td>
                    <td style="font-size:11px">${typeLabel}</td>
                    <td><span class="task-status-badge ${getTaskStatusClass(t.status)}">${t.status}</span></td>
                    <td style="color:${pColor}">${t.priority || '-'}</td>
                    <td style="font-size:12px">${escapeHtml((t.assignee || 'Unassigned').split(' ').slice(0,2).join(' '))}</td>
                    <td style="font-size:12px">${t.platform || '-'}</td>
                    <td style="font-size:11px">${escapeHtml((t.sprint || '-').substring(0, 30))}</td>
                    <td class="${etaClass}">${etaDisplay}</td>
                    <td style="font-size:11px;color:#94a3b8">${t.created || '-'}</td>
                    <td style="font-size:11px;color:#94a3b8">${t.updated || '-'}</td>
                </tr>`;
            });
            html += `</tbody></table>`;

            if (filtered.length > maxRows) {
                html += `<div class="task-count-badge" style="padding:12px;text-align:center">Showing ${maxRows} of ${filtered.length} tasks. Use filters to narrow down.</div>`;
            } else {
                html += `<div class="task-count-badge" style="padding:12px;text-align:center">Showing ${filtered.length} of ${allTasks.length} tasks.</div>`;
            }

            document.getElementById('taskTableArea').innerHTML = html;
        }

        // ============================================
        // RELEASE DASHBOARD
        // ============================================
        function renderReleaseDashboard() {
            if (!allIssues || !allIssues.releases) {
                document.getElementById('releaseContent').innerHTML =
                    '<p style="color:#94a3b8;text-align:center;padding:40px;">Release data is loading. Please wait...</p>';
                return;
            }

            const releases = allIssues.releases || {};
            const releaseNames = Object.keys(releases);

            if (releaseNames.length === 0) {
                document.getElementById('releaseContent').innerHTML =
                    '<p style="color:#94a3b8;text-align:center;padding:40px;">No release/version data found. Ensure Jira issues have fixVersions set.</p>';
                document.getElementById('releaseSummaryCards').innerHTML = '';
                return;
            }

            // Filter
            const statusFilter = document.getElementById('releaseStatusFilter').value;
            const sortFilter = document.getElementById('releaseSortFilter').value;

            let filtered = releaseNames.map(name => ({ name, ...releases[name] }));

            if (statusFilter === 'unreleased') {
                filtered = filtered.filter(r => !r.released);
            } else if (statusFilter === 'released') {
                filtered = filtered.filter(r => r.released);
            }

            // Sort
            if (sortFilter === 'date') {
                filtered.sort((a, b) => (b.releaseDate || '').localeCompare(a.releaseDate || ''));
            } else if (sortFilter === 'issues') {
                filtered.sort((a, b) => b.total - a.total);
            } else {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            }

            // Summary cards
            const totalReleases = releaseNames.length;
            const unreleasedCount = releaseNames.filter(n => !releases[n].released).length;
            const releasedCount = releaseNames.filter(n => releases[n].released).length;
            const totalIssuesInReleases = releaseNames.reduce((s, n) => s + releases[n].total, 0);
            const totalBugsInReleases = releaseNames.reduce((s, n) => s + releases[n].bugs, 0);

            document.getElementById('releaseSummaryCards').innerHTML = [
                { label: 'Total Versions', value: totalReleases, cls: 'total' },
                { label: 'Unreleased', value: unreleasedCount, cls: 'open' },
                { label: 'Released', value: releasedCount, cls: 'parked' },
                { label: 'Total Issues', value: totalIssuesInReleases, cls: 'progress' },
                { label: 'Total Bugs', value: totalBugsInReleases, cls: 'review' },
            ].map(c => `<div class="card ${c.cls}"><div class="number">${c.value}</div><div class="label">${c.label}</div></div>`).join('');

            // Build release cards
            let html = '';
            filtered.forEach((rel, idx) => {
                const statusBadge = rel.released
                    ? '<span class="release-badge released">Released</span>'
                    : '<span class="release-badge unreleased">Unreleased</span>';
                const dateStr = rel.releaseDate ? rel.releaseDate : 'No date set';
                const descStr = rel.description ? `<div class="release-desc">${escapeHtml(rel.description)}</div>` : '';

                // Status distribution
                const statuses = rel.statuses || {};
                let statusHtml = Object.entries(statuses)
                    .sort((a, b) => b[1] - a[1])
                    .map(([st, cnt]) => `<span class="task-status-badge ${getTaskStatusClass(st)}">${st}: ${cnt}</span>`)
                    .join(' ');

                // Issue type breakdown
                const breakdownParts = [];
                if (rel.bugs > 0) breakdownParts.push(`<span style="color:#ef4444">Bugs: ${rel.bugs}</span>`);
                if (rel.tasks > 0) breakdownParts.push(`<span style="color:#3b82f6">Tasks: ${rel.tasks}</span>`);
                if (rel.subtasks > 0) breakdownParts.push(`<span style="color:#8b5cf6">Sub-tasks: ${rel.subtasks}</span>`);
                if (rel.stories > 0) breakdownParts.push(`<span style="color:#10b981">Stories: ${rel.stories}</span>`);

                // Issues table (collapsible)
                const issues = rel.issues || [];
                let tableHtml = '';
                if (issues.length > 0) {
                    tableHtml = `<div class="release-issues-toggle" onclick="this.nextElementSibling.classList.toggle('show');this.querySelector('.toggle-icon').classList.toggle('open')">
                        <span class="toggle-icon">&#x25B6;</span> Show ${issues.length} issue${issues.length !== 1 ? 's' : ''}
                    </div>
                    <div class="release-issues-table">
                        <table class="task-table"><thead><tr>
                            <th>Ticket</th><th>Summary</th><th>Type</th><th>Status</th><th>Priority</th><th>Assignee</th><th>Platform</th>
                        </tr></thead><tbody>`;

                    issues.forEach(iss => {
                        const pColor = iss.priority === 'Highest' ? '#ef4444' : iss.priority === 'High' ? '#f97316' : iss.priority === 'Medium' ? '#fbbf24' : '#94a3b8';
                        tableHtml += `<tr>
                            <td><a class="key-link" href="https://hbeindia.atlassian.net/browse/${iss.key}" target="_blank">${iss.key}</a></td>
                            <td class="summary-cell">${escapeHtml((iss.summary || '').substring(0, 80))}</td>
                            <td style="font-size:11px">${iss.type}</td>
                            <td><span class="task-status-badge ${getTaskStatusClass(iss.status)}">${iss.status}</span></td>
                            <td style="color:${pColor}">${iss.priority || '-'}</td>
                            <td style="font-size:12px">${escapeHtml((iss.assignee || 'Unassigned').split(' ').slice(0, 2).join(' '))}</td>
                            <td style="font-size:12px">${iss.platform || '-'}</td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table></div>`;
                }

                html += `<div class="release-card">
                    <div class="release-card-header">
                        <div class="release-card-title">
                            <h3>${escapeHtml(rel.name)}</h3>
                            ${statusBadge}
                        </div>
                        <div class="release-card-meta">
                            <span class="release-date">${dateStr}</span>
                            <span class="release-total">Total: <b>${rel.total}</b></span>
                        </div>
                    </div>
                    ${descStr}
                    <div class="release-breakdown">${breakdownParts.join(' &bull; ')}</div>
                    <div class="release-statuses">${statusHtml}</div>
                    ${tableHtml}
                </div>`;
            });

            if (filtered.length === 0) {
                html = '<p style="color:#94a3b8;text-align:center;padding:40px;">No releases match the current filter.</p>';
            }

            document.getElementById('releaseContent').innerHTML = html;
        }

        // ============================================
        // CHATBOT
        // ============================================
        function initChatbot() {
            addBotMessage(`Hello! I'm the <b>VZY Jira Assistant</b>. I can help you with detailed bug, task, and project information.<br><br>
                <b>What I can do:</b><br>
                &#x2022; <b>Show tickets</b> - "show open bug tickets", "list in progress tickets"<br>
                &#x2022; <b>Platform bugs</b> - "Android bugs", "all IOS tickets raised so far"<br>
                &#x2022; <b>Assignee info</b> - "assigned to [name]", "assignee workload"<br>
                &#x2022; <b>Priority</b> - "high priority bugs", "priority breakdown"<br>
                &#x2022; <b>Sprint</b> - "sprint status"<br>
                &#x2022; <b>Date filters</b> - "bugs created today", "bugs from last 7 days", "bugs on 11th feb"<br>
                &#x2022; <b>Search</b> - "search video playback"<br>
                &#x2022; <b>Tasks/Stories</b> - "show tasks", "show stories"<br>
                &#x2022; <b>Dashboard</b> - bug summary, compare platforms, critical platforms<br><br>
                Try the quick action buttons below or type your question!`);
        }

        function addBotMessage(html) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg bot';
            msg.innerHTML = `<div class="avatar">&#x1f916;</div><div class="bubble">${html}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function addUserMessage(text) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg user';
            msg.innerHTML = `<div class="avatar">&#x1f464;</div><div class="bubble">${escapeHtml(text)}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping() {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg bot';
            msg.id = 'typingMsg';
            msg.innerHTML = `<div class="avatar">&#x1f916;</div><div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const el = document.getElementById('typingMsg');
            if (el) el.remove();
        }

        function escapeHtml(str) {
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function parseDateRange(q) {
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const today = new Date(todayStr + 'T00:00:00');
            const field = (q.includes('updated') || q.includes('modified') || q.includes('changed')) ? 'updated' : 'created';
            const MONTHS = { jan:0, feb:1, mar:2, apr:3, may:4, jun:5, jul:6, aug:7, sep:8, oct:9, nov:10, dec:11 };
            let from = null, to = null, label = '';

            // 1. ISO date (2026-02-11)
            const isoMatch = q.match(/\b(\d{4}-\d{2}-\d{2})\b/);
            if (isoMatch) {
                from = new Date(isoMatch[1] + 'T00:00:00');
                to = new Date(isoMatch[1] + 'T23:59:59');
                label = `on ${from.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            }

            // 2. "11th feb" or "feb 11" formats
            if (!from) {
                const dmMatch = q.match(/\b(\d{1,2})(?:st|nd|rd|th)?\s+(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\w*/);
                const mdMatch = q.match(/\b(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\w*\s+(\d{1,2})(?:st|nd|rd|th)?\b/);
                let day, mon;
                if (dmMatch) { day = parseInt(dmMatch[1]); mon = MONTHS[dmMatch[2]]; }
                else if (mdMatch) { day = parseInt(mdMatch[2]); mon = MONTHS[mdMatch[1]]; }
                if (day && mon !== undefined) {
                    let year = now.getFullYear();
                    let d = new Date(year, mon, day);
                    if (d > now) d = new Date(year - 1, mon, day);
                    if (!isNaN(d.getTime())) {
                        from = new Date(d); from.setHours(0,0,0,0);
                        to = new Date(d); to.setHours(23,59,59,999);
                        label = `on ${from.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    }
                }
            }

            // 3. Relative keywords
            if (!from) {
                if (q.includes('today')) {
                    from = new Date(today); to = new Date(today); to.setHours(23,59,59,999);
                    label = `Today (${today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
                } else if (q.includes('yesterday')) {
                    from = new Date(today); from.setDate(from.getDate() - 1);
                    to = new Date(from); to.setHours(23,59,59,999);
                    label = `Yesterday (${from.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
                } else if (q.includes('this week')) {
                    from = new Date(today);
                    const dow = from.getDay();
                    from.setDate(from.getDate() - (dow === 0 ? 6 : dow - 1));
                    to = new Date(today); to.setHours(23,59,59,999);
                    label = 'This Week';
                } else if (q.includes('last week')) {
                    from = new Date(today);
                    const dow = from.getDay();
                    from.setDate(from.getDate() - (dow === 0 ? 13 : dow + 6));
                    to = new Date(from); to.setDate(to.getDate() + 6); to.setHours(23,59,59,999);
                    label = 'Last Week';
                } else if (q.includes('this month')) {
                    from = new Date(today.getFullYear(), today.getMonth(), 1);
                    to = new Date(today); to.setHours(23,59,59,999);
                    label = 'This Month';
                } else if (q.includes('last month')) {
                    from = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    to = new Date(today.getFullYear(), today.getMonth(), 0); to.setHours(23,59,59,999);
                    label = 'Last Month';
                } else {
                    const lastNMatch = q.match(/last\s+(\d+)\s+days?/);
                    if (lastNMatch) {
                        const n = parseInt(lastNMatch[1]);
                        from = new Date(today); from.setDate(from.getDate() - n);
                        to = new Date(today); to.setHours(23,59,59,999);
                        label = `Last ${n} Days`;
                    }
                }
            }

            // 4. Implicit recency
            if (!from && (q.includes('latest') || q.includes('newest') || q.includes('recent') ||
                (q.includes('new') && (q.includes('bug') || q.includes('ticket'))))) {
                from = new Date(today); from.setDate(from.getDate() - 7);
                to = new Date(today); to.setHours(23,59,59,999);
                label = 'Last 7 Days (Recent)';
            }

            if (!from || isNaN(from.getTime())) return null;
            return { from, to, field, label };
        }

        function askBot(query) {
            document.getElementById('chatInput').value = query;
            sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            addUserMessage(text);
            showTyping();
            setTimeout(() => {
                hideTyping();
                const response = processQuery(text);
                addBotMessage(response);
            }, 500 + Math.random() * 500);
        }

        // ============================================
        // CHATBOT HELPER FUNCTIONS
        // ============================================
        const STATUS_NAME_MAP = {
            'OPEN': 'Open', 'IN PROGRESS': 'In Progress', 'REOPENED': 'Reopened',
            'IN REVIEW': 'In Review', 'ISSUE ACCEPTED': 'Issue Accepted', 'PARKED': 'Parked'
        };

        function buildTicketTable(items, maxRows = 20, showDate = false) {
            if (!items || items.length === 0) return '<br>No tickets found.';
            const display = items.slice(0, maxRows);
            let html = `<table style="width:100%;margin-top:8px"><thead><tr>
                <th style="text-align:left">Key</th><th style="text-align:left">Summary</th><th>Platform</th><th>Assignee</th><th>Priority</th><th>Status</th>`;
            if (showDate) html += `<th>Created</th>`;
            html += `</tr></thead><tbody>`;
            display.forEach(item => {
                const pColor = item.priority === 'Highest' ? '#ef4444' : item.priority === 'High' ? '#f97316' : item.priority === 'Medium' ? '#fbbf24' : '#94a3b8';
                html += `<tr>
                    <td style="white-space:nowrap;font-size:11px"><a class="key-link" href="https://hbeindia.atlassian.net/browse/${item.key}" target="_blank">${item.key}</a></td>
                    <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml((item.summary || '').substring(0, 60))}</td>
                    <td style="font-size:11px;text-align:center">${item.platform || 'N/A'}</td>
                    <td style="font-size:11px;text-align:center">${(item.assignee || 'Unassigned').split(' ')[0]}</td>
                    <td style="font-size:11px;text-align:center;color:${pColor}">${item.priority || 'N/A'}</td>
                    <td style="font-size:10px;text-align:center"><span class="inline-badge">${item.status}</span></td>`;
                if (showDate) html += `<td style="font-size:10px;text-align:center;color:#94a3b8">${item.created || 'N/A'}</td>`;
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            if (items.length > maxRows) {
                html += `<br><small style="color:#94a3b8">Showing ${maxRows} of ${items.length} tickets. Narrow down by platform, assignee, or priority.</small>`;
            }
            return html;
        }

        function filterBugs(opts = {}) {
            if (!allIssues || !allIssues.bugs) return [];
            let results = allIssues.bugs;
            if (opts.status) results = results.filter(b => b.status && b.status.toUpperCase() === opts.status.toUpperCase());
            if (opts.statusList) results = results.filter(b => b.status && opts.statusList.some(s => b.status.toUpperCase() === s.toUpperCase()));
            if (opts.platform) results = results.filter(b => b.platform && b.platform.toUpperCase() === opts.platform.toUpperCase());
            if (opts.assignee) results = results.filter(b => b.assignee && b.assignee.toLowerCase().includes(opts.assignee.toLowerCase()));
            if (opts.priority) results = results.filter(b => b.priority && b.priority.toUpperCase() === opts.priority.toUpperCase());
            if (opts.keyword) results = results.filter(b => b.summary && b.summary.toLowerCase().includes(opts.keyword.toLowerCase()));
            if (opts.createdAfter) results = results.filter(b => b.created && new Date(b.created + 'T00:00:00') >= opts.createdAfter);
            if (opts.createdBefore) results = results.filter(b => b.created && new Date(b.created + 'T23:59:59') <= opts.createdBefore);
            if (opts.updatedAfter) results = results.filter(b => b.updated && new Date(b.updated + 'T00:00:00') >= opts.updatedAfter);
            if (opts.updatedBefore) results = results.filter(b => b.updated && new Date(b.updated + 'T23:59:59') <= opts.updatedBefore);
            return results;
        }

        function filterItems(type, opts = {}) {
            if (!allIssues) return [];
            let items = allIssues[type] || [];
            if (opts.platform) items = items.filter(i => i.platform && i.platform.toUpperCase() === opts.platform.toUpperCase());
            if (opts.status) items = items.filter(i => i.status && i.status.toUpperCase() === opts.status.toUpperCase());
            if (opts.keyword) items = items.filter(i => i.summary && i.summary.toLowerCase().includes(opts.keyword.toLowerCase()));
            if (opts.createdAfter) items = items.filter(i => i.created && new Date(i.created + 'T00:00:00') >= opts.createdAfter);
            if (opts.createdBefore) items = items.filter(i => i.created && new Date(i.created + 'T23:59:59') <= opts.createdBefore);
            if (opts.updatedAfter) items = items.filter(i => i.updated && new Date(i.updated + 'T00:00:00') >= opts.updatedAfter);
            if (opts.updatedBefore) items = items.filter(i => i.updated && new Date(i.updated + 'T23:59:59') <= opts.updatedBefore);
            return items;
        }

        // ============================================
        // CHATBOT QUERY PROCESSOR
        // ============================================
        function processQuery(query) {
            if (!dashboardData) return 'Dashboard data is not loaded yet. Please refresh and try again.';
            const q = query.toLowerCase().trim();
            const data = dashboardData;

            // Compute dashboard helper data
            const platformTotals = {};
            const totals = {};
            STATUSES.forEach(s => totals[s] = 0);
            let grandTotal = 0;
            PLATFORMS.forEach(p => {
                let pTotal = 0;
                STATUSES.forEach(s => {
                    const val = data[p]?.[s] || 0;
                    totals[s] += val;
                    pTotal += val;
                });
                platformTotals[p] = pTotal;
                grandTotal += pTotal;
            });

            const matchedPlatform = PLATFORMS.find(p => q.includes(p.toLowerCase()));

            // ==============================================
            // DETAILED DATA QUERIES (uses allIssues)
            // ==============================================

            // --- DATE-BASED QUERIES ---
            if (allIssues) {
                const dateRange = parseDateRange(q);
                if (dateRange) {
                    const filterOpts = { platform: matchedPlatform || undefined };
                    if (dateRange.field === 'updated') {
                        filterOpts.updatedAfter = dateRange.from;
                        filterOpts.updatedBefore = dateRange.to;
                    } else {
                        filterOpts.createdAfter = dateRange.from;
                        filterOpts.createdBefore = dateRange.to;
                    }
                    // Detect status filter
                    const detectedStatus = Object.entries(STATUS_NAME_MAP).find(([k]) => q.includes(k.toLowerCase()));
                    if (detectedStatus) filterOpts.status = detectedStatus[1];
                    // Detect priority filter
                    const priorities = ['Highest', 'High', 'Medium', 'Low', 'Lowest'];
                    const detectedPriority = priorities.find(p => q.includes(p.toLowerCase()));
                    if (detectedPriority) filterOpts.priority = detectedPriority;

                    let bugs = filterBugs(filterOpts);
                    // Sort by date descending
                    bugs.sort((a, b) => {
                        const dateA = dateRange.field === 'updated' ? (a.updated || '') : (a.created || '');
                        const dateB = dateRange.field === 'updated' ? (b.updated || '') : (b.created || '');
                        return dateB.localeCompare(dateA);
                    });

                    const fieldLabel = dateRange.field === 'updated' ? 'Updated' : 'Created';
                    let title = `Bugs ${fieldLabel} ${dateRange.label}`;
                    if (matchedPlatform) title += ` (${matchedPlatform})`;
                    if (detectedStatus) title += ` - ${detectedStatus[1]}`;
                    if (detectedPriority) title += ` - ${detectedPriority} Priority`;

                    let html = `<b>${title}</b><br>`;
                    html += `Found: <b style="color:#60a5fa">${bugs.length}</b> bugs<br>`;
                    if (bugs.length === 0) {
                        html += `<br>No bugs found for this date range. Try a wider range like "this week" or "last 7 days".`;
                    } else {
                        html += buildTicketTable(bugs, 30, true);
                    }
                    return html;
                }
            }

            // --- SEARCH: "search [keyword]" or "find [keyword]" ---
            if (allIssues && (q.startsWith('search ') || q.startsWith('find '))) {
                const keyword = q.replace(/^(search|find)\s+/, '').trim();
                if (keyword.length < 2) return 'Please provide a search term (at least 2 characters).';
                const results = filterBugs({ keyword });
                let html = `<b>Search Results for "${escapeHtml(keyword)}"</b><br>Found: <b style="color:#60a5fa">${results.length}</b> bugs<br>`;
                html += buildTicketTable(results);
                return html;
            }

            // --- SPRINT STATUS ---
            if (allIssues && q.includes('sprint')) {
                const sprints = allIssues.sprints;
                if (!sprints || Object.keys(sprints).length === 0) return 'No sprint data available in the project.';
                let html = `<b>Sprint Status</b><br><br>`;
                Object.entries(sprints).forEach(([name, sprintData]) => {
                    html += `&#x1f3c3; <b>${escapeHtml(name)}</b><br>`;
                    html += `Total: <b>${sprintData.total}</b> (Bugs: ${sprintData.bugs}, Tasks: ${sprintData.tasks}, Sub-tasks: ${sprintData.subtasks || 0}, Stories: ${sprintData.stories})<br>`;
                    html += `<table style="width:100%;margin:4px 0 12px"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                    Object.entries(sprintData.statuses).sort((a,b) => b[1] - a[1]).forEach(([status, count]) => {
                        html += `<tr><td>${status}</td><td style="text-align:center"><b>${count}</b></td></tr>`;
                    });
                    html += `</tbody></table>`;
                });
                return html;
            }

            // --- ASSIGNEE QUERIES ---
            if (allIssues && (q.includes('assigned to') || q.includes('bugs of'))) {
                const nameMatch = q.match(/(?:assigned to|bugs of)\s+(.+)/);
                if (nameMatch) {
                    const name = nameMatch[1].trim();
                    const bugs = filterBugs({ assignee: name });
                    let html = `<b>Bugs Assigned to "${escapeHtml(name)}"</b><br>Found: <b style="color:#60a5fa">${bugs.length}</b><br>`;
                    html += buildTicketTable(bugs);
                    return html;
                }
            }
            if (allIssues && (q.includes('assignee') || q.includes('workload') || q.includes('who has most'))) {
                const workload = allIssues.assignee_workload || {};
                const sorted = Object.entries(workload).sort((a,b) => b[1].total - a[1].total).slice(0, 20);
                let html = `<b>Assignee Workload (Top 20)</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th style="text-align:left">Assignee</th><th>Bugs</th><th>Tasks</th><th>Sub-tasks</th><th>Total</th></tr></thead><tbody>`;
                sorted.forEach(([name, d]) => {
                    html += `<tr><td style="font-size:12px">${escapeHtml(name)}</td><td style="text-align:center">${d.bugs}</td><td style="text-align:center">${d.tasks}</td><td style="text-align:center">${d.subtasks || 0}</td><td style="text-align:center"><b>${d.total}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                return html;
            }

            // --- PRIORITY QUERIES ---
            if (allIssues && q.includes('priority')) {
                const priorities = ['Highest', 'High', 'Medium', 'Low', 'Lowest'];
                const matchedPriority = priorities.find(p => q.includes(p.toLowerCase()));
                if (matchedPriority) {
                    const bugs = filterBugs({ priority: matchedPriority });
                    let html = `<b>${matchedPriority} Priority Bugs</b><br>Found: <b style="color:#60a5fa">${bugs.length}</b><br>`;
                    html += buildTicketTable(bugs);
                    return html;
                }
                // Show breakdown
                const pb = allIssues.priority_breakdown || {};
                let html = `<b>Bug Priority Breakdown</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Priority</th><th>Count</th></tr></thead><tbody>`;
                const pColors = {'Highest':'#ef4444','High':'#f97316','Medium':'#fbbf24','Low':'#34d399','Lowest':'#94a3b8'};
                priorities.forEach(p => {
                    if (pb[p]) html += `<tr><td><b style="color:${pColors[p]||'#e2e8f0'}">${p}</b></td><td style="text-align:center"><b>${pb[p]}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                return html;
            }

            // --- SUB-TASK QUERIES ---
            if (allIssues && (q.includes('sub-task') || q.includes('subtask') || q.includes('sub task'))) {
                const subtasks = filterItems('subtasks', { platform: matchedPlatform || undefined });
                let html = `<b>Sub-tasks${matchedPlatform ? ' - ' + matchedPlatform : ''}</b><br>Total: <b style="color:#60a5fa">${subtasks.length}</b><br>`;
                html += buildTicketTable(subtasks);
                return html;
            }

            // --- TASK QUERIES ---
            if (allIssues && q.includes('task')) {
                const tasks = filterItems('tasks', { platform: matchedPlatform || undefined });
                let html = `<b>Tasks${matchedPlatform ? ' - ' + matchedPlatform : ''}</b><br>Total: <b style="color:#60a5fa">${tasks.length}</b><br>`;
                html += buildTicketTable(tasks);
                return html;
            }

            // --- STORY QUERIES ---
            if (allIssues && q.includes('stor')) {
                const stories = filterItems('stories');
                let html = `<b>Stories</b><br>Total: <b style="color:#60a5fa">${stories.length}</b><br>`;
                html += buildTicketTable(stories);
                return html;
            }

            // --- ALL TICKETS / HISTORICAL / TOTAL RAISED ---
            if (allIssues && (q.includes('raised') || q.includes('so far') || q.includes('historical') || q.includes('ever') ||
                (q.includes('all') && q.includes('ticket')) || (q.includes('total') && matchedPlatform && !q.includes('summary')))) {
                let bugs = allIssues.bugs || [];
                if (matchedPlatform) bugs = bugs.filter(b => b.platform && b.platform.toUpperCase() === matchedPlatform.toUpperCase());
                const statusCounts = {};
                bugs.forEach(b => { statusCounts[b.status] = (statusCounts[b.status] || 0) + 1; });
                let html = `<b>All ${matchedPlatform || ''} Bugs Raised (Historical)</b><br><br>`;
                html += `Total: <b style="color:#60a5fa">${bugs.length}</b> bugs across all statuses<br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                Object.entries(statusCounts).sort((a,b) => b[1] - a[1]).forEach(([status, count]) => {
                    html += `<tr><td>${status}</td><td style="text-align:center"><b>${count}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                html += `<br><b>Recent Tickets:</b>`;
                html += buildTicketTable(bugs.slice(0, 15), 15);
                return html;
            }

            // --- TICKET / JIRA ID QUERIES (with status/platform filters) ---
            if (allIssues && (q.includes('ticket') || q.includes('jira') || q.match(/vf-\d/))) {
                // Detect status filter from query
                let statusFilter = null;
                for (const [dashName, detailName] of Object.entries(STATUS_NAME_MAP)) {
                    if (q.includes(dashName.toLowerCase())) { statusFilter = detailName; break; }
                }
                // Also check direct status names
                if (!statusFilter) {
                    const allStatuses = [...new Set((allIssues.bugs || []).map(b => b.status))];
                    statusFilter = allStatuses.find(s => q.includes(s.toLowerCase())) || null;
                }
                // Check specific ticket ID
                const ticketMatch = q.match(/vf-(\d+)/i);
                if (ticketMatch) {
                    const ticketKey = 'VF-' + ticketMatch[1];
                    const allItems = [...(allIssues.bugs || []), ...(allIssues.tasks || []), ...(allIssues.stories || [])];
                    const found = allItems.find(i => i.key.toUpperCase() === ticketKey.toUpperCase());
                    if (found) {
                        let html = `<b>Ticket: ${found.key}</b><br><br>`;
                        html += `<b>Summary:</b> ${escapeHtml(found.summary)}<br>`;
                        html += `<b>Type:</b> ${found.type}<br>`;
                        html += `<b>Status:</b> ${found.status}<br>`;
                        html += `<b>Priority:</b> ${found.priority}<br>`;
                        html += `<b>Platform:</b> ${found.platform}<br>`;
                        html += `<b>Assignee:</b> ${found.assignee}<br>`;
                        html += `<b>Created:</b> ${found.created}<br>`;
                        html += `<b>Updated:</b> ${found.updated}<br>`;
                        html += `<b>Sprint:</b> ${found.sprint}<br>`;
                        html += `<br><a href="https://hbeindia.atlassian.net/browse/${found.key}" target="_blank" style="color:#60a5fa">Open in Jira &#x2197;</a>`;
                        return html;
                    } else {
                        return `Ticket <b>${ticketKey}</b> not found in the data.`;
                    }
                }

                const filtered = filterBugs({
                    status: statusFilter || undefined,
                    platform: matchedPlatform || undefined
                });
                let title = 'Jira Bug Tickets';
                if (statusFilter) title += ` - ${statusFilter}`;
                if (matchedPlatform) title += ` (${matchedPlatform})`;
                let html = `<b>${title}</b><br>Found: <b style="color:#60a5fa">${filtered.length}</b> tickets<br>`;
                html += buildTicketTable(filtered);
                return html;
            }

            // ==============================================
            // DASHBOARD AGGREGATE QUERIES (uses dashboardData)
            // ==============================================

            // Bug Summary
            if (q.includes('summary') || q.includes('overview') || q === 'bugs' || q === 'bug summary') {
                let html = `<b>Bug Summary (VZY Project)</b><br><br>`;
                html += `Total Active Bugs: <b style="color:#60a5fa">${grandTotal}</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                STATUSES.forEach(s => {
                    html += `<tr><td><span class="inline-badge" style="background:${STATUS_COLORS[s]}33;color:${STATUS_COLORS[s]}">${s}</span></td><td style="text-align:center"><b>${totals[s]}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                if (allIssues) {
                    const totalAll = (allIssues.bugs || []).length;
                    html += `<br><small style="color:#94a3b8">Total bugs raised (all statuses): <b>${totalAll}</b> | Tasks: <b>${(allIssues.tasks || []).length}</b> | Stories: <b>${(allIssues.stories || []).length}</b></small>`;
                }
                return html;
            }

            // Specific platform query
            if (matchedPlatform) {
                const pData = data[matchedPlatform] || {};
                const pTotal = platformTotals[matchedPlatform];
                let html = `<b>${matchedPlatform} Bugs (Active)</b><br><br>`;
                html += `Active: <b style="color:${pTotal >= 4 ? '#f87171' : pTotal >= 2 ? '#fbbf24' : '#34d399'}">${pTotal}</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>`;
                STATUSES.forEach(s => {
                    const val = pData[s] || 0;
                    if (val > 0) {
                        html += `<tr><td><span class="inline-badge" style="background:${STATUS_COLORS[s]}33;color:${STATUS_COLORS[s]}">${s}</span></td><td style="text-align:center"><b>${val}</b></td></tr>`;
                    }
                });
                html += `</tbody></table>`;
                // Append ticket details
                if (allIssues) {
                    const activeStatuses = Object.values(STATUS_NAME_MAP);
                    const tickets = filterBugs({ platform: matchedPlatform, statusList: activeStatuses });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                    const allPlatformBugs = filterBugs({ platform: matchedPlatform });
                    html += `<br><small style="color:#94a3b8">Total ${matchedPlatform} bugs raised (all statuses): <b>${allPlatformBugs.length}</b></small>`;
                }
                if (pTotal === 0 && !allIssues) html += `<br>No active bugs on this platform.`;
                return html;
            }

            // Status-based queries
            for (const status of STATUSES) {
                if (q.includes(status.toLowerCase())) {
                    const platforms = PLATFORMS.filter(p => (data[p]?.[status] || 0) > 0);
                    let html = `<b>${status} Bugs</b><br><br>`;
                    html += `Total: <b style="color:${STATUS_COLORS[status]}">${totals[status]}</b><br><br>`;
                    if (platforms.length === 0) {
                        html += `No bugs currently in ${status} status.`;
                    } else {
                        html += `<table style="width:100%"><thead><tr><th>Platform</th><th>Count</th></tr></thead><tbody>`;
                        platforms.forEach(p => {
                            html += `<tr><td>${p}</td><td style="text-align:center"><b>${data[p][status]}</b></td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                    // Append ticket details
                    if (allIssues) {
                        const detailedStatus = STATUS_NAME_MAP[status];
                        if (detailedStatus) {
                            const tickets = filterBugs({ status: detailedStatus });
                            if (tickets.length > 0) {
                                html += `<br><b>Ticket Details:</b>`;
                                html += buildTicketTable(tickets);
                            }
                        }
                    }
                    return html;
                }
            }

            // Open bugs
            if (q.includes('open')) {
                const platforms = PLATFORMS.filter(p => (data[p]?.['OPEN'] || 0) > 0);
                let html = `<b>Open Bugs</b><br><br>Total: <b style="color:#ef4444">${totals['OPEN']}</b><br><br>`;
                if (platforms.length === 0) html += 'No open bugs currently!';
                else {
                    html += `<table style="width:100%"><thead><tr><th>Platform</th><th>Count</th></tr></thead><tbody>`;
                    platforms.forEach(p => html += `<tr><td>${p}</td><td style="text-align:center"><b>${data[p]['OPEN']}</b></td></tr>`);
                    html += `</tbody></table>`;
                }
                if (allIssues) {
                    const tickets = filterBugs({ status: 'Open' });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                }
                return html;
            }

            // Top / most / highest platform
            if (q.includes('most') || q.includes('top') || q.includes('highest') || q.includes('worst')) {
                const sorted = [...PLATFORMS].sort((a, b) => platformTotals[b] - platformTotals[a]);
                const top = sorted[0];
                let html = `<b>Platform with Most Bugs</b><br><br>`;
                html += `<b style="color:#f87171">${top}</b> has the most bugs with <b>${platformTotals[top]}</b> total.<br><br>`;
                html += `<b>Full Ranking:</b><br>`;
                sorted.forEach((p, i) => {
                    const clr = platformTotals[p] >= 4 ? '#f87171' : platformTotals[p] >= 2 ? '#fbbf24' : '#34d399';
                    html += `${i + 1}. ${p}: <b style="color:${clr}">${platformTotals[p]}</b><br>`;
                });
                return html;
            }

            // Compare platforms
            if (q.includes('compare') || q.includes('comparison') || q.includes('breakdown') || q.includes('platform-wise') || q.includes('all platform')) {
                let html = `<b>Platform Comparison</b><br><br>`;
                html += `<table style="width:100%"><thead><tr><th>Platform</th>`;
                STATUSES.forEach(s => html += `<th style="font-size:9px">${s.split(' ').map(w=>w[0]).join('')}</th>`);
                html += `<th>Total</th></tr></thead><tbody>`;
                [...PLATFORMS].sort((a, b) => platformTotals[b] - platformTotals[a]).forEach(p => {
                    html += `<tr><td style="font-size:12px">${p}</td>`;
                    STATUSES.forEach(s => {
                        const val = data[p]?.[s] || 0;
                        html += `<td style="text-align:center">${val > 0 ? `<b>${val}</b>` : '<span style="color:#475569">0</span>'}</td>`;
                    });
                    html += `<td style="text-align:center"><b>${platformTotals[p]}</b></td></tr>`;
                });
                html += `</tbody></table>`;
                html += `<br><small>Columns: O=Open, IP=InProgress, R=Reopened, IR=InReview, IA=Accepted, P=Parked</small>`;
                return html;
            }

            // Critical platforms
            if (q.includes('critical') || q.includes('attention') || q.includes('alert') || q.includes('warning')) {
                const critical = PLATFORMS.filter(p => platformTotals[p] >= 4);
                const warning = PLATFORMS.filter(p => platformTotals[p] >= 2 && platformTotals[p] < 4);
                let html = `<b>Platform Health Status</b><br><br>`;
                if (critical.length > 0) {
                    html += `<span style="color:#f87171">&#x1f534; Critical (4+ bugs):</span><br>`;
                    critical.forEach(p => html += `&nbsp;&nbsp;&#x2022; ${p}: <b>${platformTotals[p]}</b> bugs<br>`);
                } else {
                    html += `<span style="color:#34d399">No critical platforms (4+ bugs)</span><br>`;
                }
                html += `<br>`;
                if (warning.length > 0) {
                    html += `<span style="color:#fbbf24">&#x1f7e1; Warning (2-3 bugs):</span><br>`;
                    warning.forEach(p => html += `&nbsp;&nbsp;&#x2022; ${p}: <b>${platformTotals[p]}</b> bugs<br>`);
                }
                return html;
            }

            // Healthy platforms
            if (q.includes('health') || q.includes('good') || q.includes('clean')) {
                const healthy = PLATFORMS.filter(p => platformTotals[p] <= 1);
                let html = `<b>Healthy Platforms (0-1 bugs)</b><br><br>`;
                if (healthy.length > 0) {
                    healthy.forEach(p => html += `<span style="color:#34d399">&#x2705;</span> ${p}: <b>${platformTotals[p]}</b> bug${platformTotals[p] !== 1 ? 's' : ''}<br>`);
                } else {
                    html += `No platform currently has 0-1 bugs.`;
                }
                return html;
            }

            // Reopened
            if (q.includes('reopen')) {
                const platforms = PLATFORMS.filter(p => (data[p]?.['REOPENED'] || 0) > 0);
                let html = `<b>Reopened Bugs</b><br><br>Total: <b style="color:#f97316">${totals['REOPENED']}</b><br><br>`;
                if (platforms.length > 0) {
                    platforms.forEach(p => html += `&#x2022; ${p}: <b>${data[p]['REOPENED']}</b><br>`);
                } else {
                    html += 'No reopened bugs currently!';
                }
                if (allIssues) {
                    const tickets = filterBugs({ status: 'Reopened' });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                }
                return html;
            }

            // Parked
            if (q.includes('park')) {
                const platforms = PLATFORMS.filter(p => (data[p]?.['PARKED'] || 0) > 0);
                let html = `<b>Parked Bugs</b><br><br>Total: <b style="color:#64748b">${totals['PARKED']}</b><br><br>`;
                if (platforms.length > 0) {
                    platforms.forEach(p => html += `&#x2022; ${p}: <b>${data[p]['PARKED']}</b><br>`);
                } else {
                    html += 'No parked bugs currently.';
                }
                if (allIssues) {
                    const tickets = filterBugs({ status: 'Parked' });
                    if (tickets.length > 0) {
                        html += `<br><b>Ticket Details:</b>`;
                        html += buildTicketTable(tickets);
                    }
                }
                return html;
            }

            // Help
            if (q.includes('help') || q.includes('what can')) {
                return `<b>What I can do:</b><br><br>
                    <b>Ticket Details:</b><br>
                    &#x2022; "show open bug tickets" - List tickets by status<br>
                    &#x2022; "VF-1234" - Look up a specific ticket<br>
                    &#x2022; "search video playback" - Search by keyword<br><br>
                    <b>Historical Data:</b><br>
                    &#x2022; "all IOS tickets raised so far" - Full history by platform<br>
                    &#x2022; "total android bugs" - All-time counts<br><br>
                    <b>People & Priority:</b><br>
                    &#x2022; "assigned to [name]" - Bugs by assignee<br>
                    &#x2022; "assignee workload" - Who has the most work<br>
                    &#x2022; "high priority bugs" - Filter by priority<br>
                    &#x2022; "priority breakdown" - Priority distribution<br><br>
                    <b>Date-Based Queries:</b><br>
                    &#x2022; "bugs created today" - Today's bugs<br>
                    &#x2022; "bugs from yesterday" - Yesterday's bugs<br>
                    &#x2022; "bugs on 11th feb" - Specific date<br>
                    &#x2022; "bugs from last 7 days" - Recent bugs<br>
                    &#x2022; "bugs this week" / "this month" - Time range<br>
                    &#x2022; "bugs updated today" - Recently updated<br>
                    &#x2022; "open ios bugs from today" - Combined filters<br><br>
                    <b>Sprint & Tasks:</b><br>
                    &#x2022; "sprint status" - Sprint progress<br>
                    &#x2022; "show tasks" - List all tasks<br>
                    &#x2022; "show stories" - List all stories<br><br>
                    <b>Dashboard:</b><br>
                    &#x2022; "bug summary" - Overview counts<br>
                    &#x2022; "Android bugs" - Platform details<br>
                    &#x2022; "compare platforms" - Side-by-side<br>
                    &#x2022; "critical platforms" - Platforms needing attention`;
            }

            // Fallback
            return `I'm not sure how to answer that. Try:<br><br>
                &#x2022; "bugs created today" - Today's bugs<br>
                &#x2022; "bugs from last 7 days" - Recent bugs<br>
                &#x2022; "show open bug tickets" - Tickets with Jira IDs<br>
                &#x2022; "all IOS tickets raised so far" - Full history<br>
                &#x2022; "assigned to [name]" - Bugs by person<br>
                &#x2022; "high priority bugs" - By priority<br>
                &#x2022; "search [keyword]" - Search bugs<br>
                &#x2022; "sprint status" - Sprint info<br>
                &#x2022; "bug summary" - Overview<br><br>
                Type <b>"help"</b> for the full list.`;
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadData() {
            const btn = document.getElementById('refreshBtn');
            const loading = document.getElementById('loading');
            const errorBanner = document.getElementById('errorBanner');

            btn.disabled = true;
            btn.textContent = 'Loading...';
            errorBanner.style.display = 'none';

            try {
                const json = await fetchDataJson();
                renderDashboard(json.data);
                document.getElementById('lastUpdated').textContent =
                    `Updated: ${new Date(json.updated_at).toLocaleString()} (auto-synced from Jira)`;
                loading.style.display = 'none';

                // Also try to load detailed data for chatbot
                const detailed = await fetchDetailedData();
                if (detailed) {
                    allIssues = detailed;
                    renderBugDetails();
                }
            } catch (err) {
                console.warn('data.json not available, using static fallback:', err.message);
                try {
                    renderDashboard(getStaticData());
                    document.getElementById('lastUpdated').textContent =
                        `Updated: ${new Date().toLocaleString()} (static fallback)`;
                } catch (e) {}
                loading.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh';
            }
        }

        // Initial load
        loadData();
        setInterval(loadData, CONFIG.AUTO_REFRESH_MS);
    </script>
</body>
</html>
